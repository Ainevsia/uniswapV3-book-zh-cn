<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="function renderKatex(element) { renderMathInElement(document.body, { delimiters: [ { left: '$$', right: '$$', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }, { left: '\\[', right: '\\]', display: true } ], throwOnError: false }); }    \[ \]  Math in Solidity #  Due to Solidity not supporting numbers with th fractional part, math in Solidity is somewhat complicated."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Math in Solidity"><meta property="og:description" content="function renderKatex(element) { renderMathInElement(document.body, { delimiters: [ { left: '$$', right: '$$', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }, { left: '\\[', right: '\\]', display: true } ], throwOnError: false }); }    \[ \]  Math in Solidity #  Due to Solidity not supporting numbers with th fractional part, math in Solidity is somewhat complicated."><meta property="og:type" content="article"><meta property="og:url" content="https://uniswapv3book.com/docs/milestone_2/math-in-solidity/"><meta property="article:section" content="docs"><title>Math in Solidity | Uniswap V3 Book 中文版</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css integrity="sha256-gsXb0jRHzuC0wqo+0Izglh+qQOH6Nw7uT4yfAuDUa18=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.d6b0217789cab12411fda11381b98a7b8564b6410ec290ed237c4738da0a1f38.js integrity="sha256-1rAhd4nKsSQR/aETgbmKe4VktkEOwpDtI3xHONoKHzg=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Uniswap V3 Book 中文版</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li class=book-section-flat><span>Milestone 0. 简介</span><ul><li><a href=/docs/introduction/introduction-to-markets/>交易市场简介</a></li><li><a href=/docs/introduction/constant-function-market-maker/>恒定函数做市商(CFMM)</a></li><li><a href=/docs/introduction/uniswap-v3/>Uniswap V3</a></li><li><a href=/docs/introduction/dev-environment/>开发环境</a></li></ul></li><li class=book-section-flat><span>Milestone 1. First Swap</span><ul><li><a href=/docs/milestone_1/introduction/>Introduction</a></li><li><a href=/docs/milestone_1/calculating-liquidity/>Calculating Liquidity</a></li><li><a href=/docs/milestone_1/providing-liquidity/>Providing Liquidity</a></li><li><a href=/docs/milestone_1/first-swap/>First Swap</a></li><li><a href=/docs/milestone_1/manager-contract/>Manager Contract</a></li><li><a href=/docs/milestone_1/deployment/>Deployment</a></li><li><a href=/docs/milestone_1/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 2. Second Swap</span><ul><li><a href=/docs/milestone_2/introduction/>Introduction</a></li><li><a href=/docs/milestone_2/output-amount-calculation/>Output Amount Calculation</a></li><li><a href=/docs/milestone_2/math-in-solidity/ class=active>Math in Solidity</a></li><li><a href=/docs/milestone_2/tick-bitmap-index/>Tick Bitmap Index</a></li><li><a href=/docs/milestone_2/generalize-minting/>Generalize Minting</a></li><li><a href=/docs/milestone_2/generalize-swapping/>Generalize Swapping</a></li><li><a href=/docs/milestone_2/quoter-contract/>Quoter Contract</a></li><li><a href=/docs/milestone_2/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 3. Cross-tick Swaps</span><ul><li><a href=/docs/milestone_3/introduction/>Introduction</a></li><li><a href=/docs/milestone_3/different-ranges/>Different Price Ranges</a></li><li><a href=/docs/milestone_3/cross-tick-swaps/>Cross-Tick Swaps</a></li><li><a href=/docs/milestone_3/slippage-protection/>Slippage Protection</a></li><li><a href=/docs/milestone_3/liquidity-calculation/>Liquidity Calculation</a></li><li><a href=/docs/milestone_3/more-on-fixed-point-numbers/>A Little Bit More on Fixed-point Numbers</a></li><li><a href=/docs/milestone_3/flash-loans/>Flash Loans</a></li><li><a href=/docs/milestone_3/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 4. Multi-pool Swaps</span><ul><li><a href=/docs/milestone_4/introduction/>Introduction</a></li><li><a href=/docs/milestone_4/factory-contract/>Factory Contract</a></li><li><a href=/docs/milestone_4/path/>Swap Path</a></li><li><a href=/docs/milestone_4/multi-pool-swaps/>Multi-pool Swaps</a></li><li><a href=/docs/milestone_4/user-interface/>User Interface</a></li><li><a href=/docs/milestone_4/tick-rounding/>Tick Rounding</a></li></ul></li><li class=book-section-flat><span>Milestone 5. Fees and Price Oracle</span><ul><li><a href=/docs/milestone_5/introduction/>Introduction</a></li><li><a href=/docs/milestone_5/swap-fees/>Swap Fees</a></li><li><a href=/docs/milestone_5/flash-loan-fees/>Flash Loan Fees</a></li><li><a href=/docs/milestone_5/protocol-fees/>Protocol Fees</a></li><li><a href=/docs/milestone_5/price-oracle/>Price Oracle</a></li><li><a href=/docs/milestone_5/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 6: NFT positions</span><ul><li><a href=/docs/milestone_6/introduction/>Introduction</a></li><li><a href=/docs/milestone_6/erc721-overview/>ERC721 Overview</a></li><li><a href=/docs/milestone_6/nft-manager/>NFT Manager</a></li><li><a href=/docs/milestone_6/nft-renderer/>NFT Renderer</a></li></ul></li><li class=book-section-flat><span>补充资料</span><ul><li><a href=/docs/reference/dictionary/>中英名词对照</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Math in Solidity</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#math-in-solidity>Math in Solidity</a><ul><li><a href=#re-using-math-contracts>Re-using Math Contracts</a></li></ul></li></ul></nav></aside></header><article class=markdown><link rel=stylesheet href=/katex/katex.min.css><script>function renderKatex(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})}</script><script defer src=/katex/katex.min.js></script>
<script defer src=/katex/auto-render.min.js onload=renderKatex(document.body)></script><span>
\[ \]</span><h1 id=math-in-solidity>Math in Solidity
<a class=anchor href=#math-in-solidity>#</a></h1><p>Due to Solidity not supporting numbers with th fractional part, math in Solidity is somewhat complicated. Solidity
gives us integer and unsigned integer types, which are not enough for for more or less complex math calculations.</p><p>Another difficulty is gas consumption: the more complex an algorithm, the more gas it consumes. Thus, if we need to have
advanced math operations (like <code>exp</code>, <code>ln</code>, <code>sqrt</code>), we want them to be as gas efficient as possible.</p><p>And another big problem is the possibility of under/overflow. When multiplying <code>uint256</code> numbers, there&rsquo;s a risk of an
overflow: the result number might be so big that it won&rsquo;t fit into 256 bits.</p><p>All these difficulties force us to use third-party math libraries that implement advanced math operations and, ideally,
optimize their gas consumption. In the case when there&rsquo;s no library for an algorithm we need, we&rsquo;ll have to implement
it ourselves, which is a difficult task if we need to implement a unique computation.</p><h2 id=re-using-math-contracts>Re-using Math Contracts
<a class=anchor href=#re-using-math-contracts>#</a></h2><p>In our Uniswap V3 implementation, we&rsquo;re going to use two third-party math contracts:</p><ol><li><a href=https://github.com/paulrberg/prb-math>PRBMath</a>, which is a great library of advanced fixed-point math algorithms.
We&rsquo;ll use <code>mulDiv</code> function to handle overflows when multiplying and then dividing integer numbers.</li><li><a href=https://github.com/Uniswap/v3-core/blob/main/contracts/libraries/TickMath.sol>TickMath</a> from the original Uniswap
V3 repo. This contract implements two functions, <code>getSqrtRatioAtTick</code> and <code>getTickAtSqrtRatio</code>, which convert $\sqrt{P}$&rsquo;s
to ticks and back.</li></ol><p>Let&rsquo;s focus on the latter.</p><p>In our contracts, we&rsquo;ll need to convert ticks to corresponding $\sqrt{P}$ and back. The formulas are:</p><p>$$\sqrt{P(i)} = \sqrt{1.0001^i} = 1.0001^{\frac{i}{2}}$$</p><p>$$i = log_{\sqrt{1.0001}}\sqrt{P(i)}$$</p><p>These are complex mathematical operations (for Solidity, at least) and they require high precision because we don&rsquo;t want
to allow rounding errors when calculating prices. To have better precision and optimization we&rsquo;ll need unique implementation.</p><p>If you look at the original code of <a href=https://github.com/Uniswap/v3-core/blob/8f3e4645a08850d2335ead3d1a8d0c64fa44f222/contracts/libraries/TickMath.sol#L23-L54>getSqrtRatioAtTick</a>
and <a href=https://github.com/Uniswap/v3-core/blob/8f3e4645a08850d2335ead3d1a8d0c64fa44f222/contracts/libraries/TickMath.sol#L61-L204>getTickAtSqrtRatio</a>
you&rsquo;ll see that they&rsquo;re quite complex: there&rsquo;re a lot of magic numbers (like <code>0xfffcb933bd6fad37aa2d162d1a594001</code>),
multiplication, and bitwise operations. At this point, we&rsquo;re not going to analyze the code or re-implement it since this
is a very advanced and somewhat different topic. We&rsquo;ll use the contract as is. And, in a later milestone, we&rsquo;ll break
down the computations.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#math-in-solidity>Math in Solidity</a><ul><li><a href=#re-using-math-contracts>Re-using Math Contracts</a></li></ul></li></ul></nav></div></aside></main></body></html>