<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="function renderKatex(element) { renderMathInElement(document.body, { delimiters: [ { left: '$$', right: '$$', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }, { left: '\\[', right: '\\]', display: true } ], throwOnError: false }); }    \[ \]  Different Price Ranges #  The way we implemented it, our Pool contract creates only price ranges that include the current price:"><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Different Price Ranges"><meta property="og:description" content="function renderKatex(element) { renderMathInElement(document.body, { delimiters: [ { left: '$$', right: '$$', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }, { left: '\\[', right: '\\]', display: true } ], throwOnError: false }); }    \[ \]  Different Price Ranges #  The way we implemented it, our Pool contract creates only price ranges that include the current price:"><meta property="og:type" content="article"><meta property="og:url" content="https://uniswapv3book.com/docs/milestone_3/different-ranges/"><meta property="article:section" content="docs"><title>Different Price Ranges | Uniswap V3 Book 中文版</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css integrity="sha256-gsXb0jRHzuC0wqo+0Izglh+qQOH6Nw7uT4yfAuDUa18=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.d6d681726de96ede9e63fe231234d265e4c7c58fdfe525c8c321a5f740071758.js integrity="sha256-1taBcm3pbt6eY/4jEjTSZeTHxY/f5SXIwyGl90AHF1g=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Uniswap V3 Book 中文版</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li class=book-section-flat><span>Milestone 0. 简介</span><ul><li><a href=/docs/introduction/introduction-to-markets/>交易市场简介</a></li><li><a href=/docs/introduction/constant-function-market-maker/>恒定函数做市商(CFMM)</a></li><li><a href=/docs/introduction/uniswap-v3/>Uniswap V3</a></li><li><a href=/docs/introduction/dev-environment/>Development Environment</a></li></ul></li><li class=book-section-flat><span>Milestone 1. First Swap</span><ul><li><a href=/docs/milestone_1/introduction/>Introduction</a></li><li><a href=/docs/milestone_1/calculating-liquidity/>Calculating Liquidity</a></li><li><a href=/docs/milestone_1/providing-liquidity/>Providing Liquidity</a></li><li><a href=/docs/milestone_1/first-swap/>First Swap</a></li><li><a href=/docs/milestone_1/manager-contract/>Manager Contract</a></li><li><a href=/docs/milestone_1/deployment/>Deployment</a></li><li><a href=/docs/milestone_1/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 2. Second Swap</span><ul><li><a href=/docs/milestone_2/introduction/>Introduction</a></li><li><a href=/docs/milestone_2/output-amount-calculation/>Output Amount Calculation</a></li><li><a href=/docs/milestone_2/math-in-solidity/>Math in Solidity</a></li><li><a href=/docs/milestone_2/tick-bitmap-index/>Tick Bitmap Index</a></li><li><a href=/docs/milestone_2/generalize-minting/>Generalize Minting</a></li><li><a href=/docs/milestone_2/generalize-swapping/>Generalize Swapping</a></li><li><a href=/docs/milestone_2/quoter-contract/>Quoter Contract</a></li><li><a href=/docs/milestone_2/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 3. Cross-tick Swaps</span><ul><li><a href=/docs/milestone_3/introduction/>Introduction</a></li><li><a href=/docs/milestone_3/different-ranges/ class=active>Different Price Ranges</a></li><li><a href=/docs/milestone_3/cross-tick-swaps/>Cross-Tick Swaps</a></li><li><a href=/docs/milestone_3/slippage-protection/>Slippage Protection</a></li><li><a href=/docs/milestone_3/liquidity-calculation/>Liquidity Calculation</a></li><li><a href=/docs/milestone_3/more-on-fixed-point-numbers/>A Little Bit More on Fixed-point Numbers</a></li><li><a href=/docs/milestone_3/flash-loans/>Flash Loans</a></li><li><a href=/docs/milestone_3/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 4. Multi-pool Swaps</span><ul><li><a href=/docs/milestone_4/introduction/>Introduction</a></li><li><a href=/docs/milestone_4/factory-contract/>Factory Contract</a></li><li><a href=/docs/milestone_4/path/>Swap Path</a></li><li><a href=/docs/milestone_4/multi-pool-swaps/>Multi-pool Swaps</a></li><li><a href=/docs/milestone_4/user-interface/>User Interface</a></li><li><a href=/docs/milestone_4/tick-rounding/>Tick Rounding</a></li></ul></li><li class=book-section-flat><span>Milestone 5. Fees and Price Oracle</span><ul><li><a href=/docs/milestone_5/introduction/>Introduction</a></li><li><a href=/docs/milestone_5/swap-fees/>Swap Fees</a></li><li><a href=/docs/milestone_5/flash-loan-fees/>Flash Loan Fees</a></li><li><a href=/docs/milestone_5/protocol-fees/>Protocol Fees</a></li><li><a href=/docs/milestone_5/price-oracle/>Price Oracle</a></li><li><a href=/docs/milestone_5/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 6: NFT positions</span><ul><li><a href=/docs/milestone_6/introduction/>Introduction</a></li><li><a href=/docs/milestone_6/erc721-overview/>ERC721 Overview</a></li><li><a href=/docs/milestone_6/nft-manager/>NFT Manager</a></li><li><a href=/docs/milestone_6/nft-renderer/>NFT Renderer</a></li></ul></li><li class=book-section-flat><span>补充资料</span><ul><li><a href=/docs/reference/dictionary/>中英名词对照</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Different Price Ranges</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#different-price-ranges>Different Price Ranges</a><ul><li><a href=#limit-orders>Limit Orders</a></li><li><a href=#updating-mint-function>Updating <code>mint</code> Function</a></li></ul></li></ul></nav></aside></header><article class=markdown><link rel=stylesheet href=/katex/katex.min.css><script>function renderKatex(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})}</script><script defer src=/katex/katex.min.js></script>
<script defer src=/katex/auto-render.min.js onload=renderKatex(document.body)></script><span>
\[ \]</span><h1 id=different-price-ranges>Different Price Ranges
<a class=anchor href=#different-price-ranges>#</a></h1><p>The way we implemented it, our Pool contract creates only price ranges that include the current price:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span><span style=color:#75715e>// src/UniswapV3Pool.sol
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>mint</span>(
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    amount0 <span style=color:#f92672>=</span> Math.calcAmount0Delta(
</span></span><span style=display:flex><span>        slot0_.sqrtPriceX96,
</span></span><span style=display:flex><span>        TickMath.getSqrtRatioAtTick(upperTick),
</span></span><span style=display:flex><span>        amount
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    amount1 <span style=color:#f92672>=</span> Math.calcAmount1Delta(
</span></span><span style=display:flex><span>        slot0_.sqrtPriceX96,
</span></span><span style=display:flex><span>        TickMath.getSqrtRatioAtTick(lowerTick),
</span></span><span style=display:flex><span>        amount
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    liquidity <span style=color:#f92672>+=</span> <span style=color:#66d9ef>uint128</span>(amount);
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>From this piece you can also see that we always update the liquidity tracker (which tracks only currently available
liquidity, i.e. liquidity available at the current price).</p><p>However, in reality, price ranges can also be created <strong>below or above</strong> the current price. That&rsquo;s it: the design of
Uniswap V3 allows liquidity provider to provide liquidity that doesn&rsquo;t get immediately used; such liquidity gets &ldquo;injected&rdquo;
when current price gets into the &ldquo;sleeping&rdquo; price ranges.</p><p>These are kinds of price ranges that can exist:</p><ol><li>Active price range, i.e. one that includes current price.</li><li>Price range placed below current price. The upper tick of this range is below the current tick.</li><li>Price range placed above current price. The lower tick of this range is above the current tick.</li></ol><h2 id=limit-orders>Limit Orders
<a class=anchor href=#limit-orders>#</a></h2><p>An interesting fact about inactive liquidity (i.e. liquidity not provided at current price) is that it acts as <em>limit
orders</em>.</p><p>In trading, limit orders are orders that get executed when price crosses a level chosen by trader. For example, you can
place a limit order that buys 1 ETH when its price drops to $1000. Similarly, you can use limit order to sell assets.
With Uniswap V3, you can get similar behavior by placing liquidity at ranges that are below or above current price. Let&rsquo;s
see how this works:</p><p>[TODO: illustrate liquidity to the left and to the right of the current price]</p><p>If you provide liquidity below current price (i.e. the price range you chose lays entirely below the current price) or
above it, then your whole liquidity will be composed of <strong>only one asset</strong>–the asset will be the cheapest one of the two.
In our example, we&rsquo;re building a pool with ETH being token $X$ and USDC being token $Y$, and we define the price as:</p><p>$$P = \frac{y}{x}$$</p><p>If we put liquidity below current price, then the liquidity will be composed of USDC solely because, where we added the
liquidity, the price of USDC is lower than the current price. Likewise, when we put liquidity above current price, then
the liquidity will be composed of ETH because ETH is cheaper in that range.</p><p>If this sounds confusing, let&rsquo;s look at one price range in isolation:</p><p>[TODO: illustrate a price range, curve with current/lower/upper prices]</p><p>If we buy all available amount of token $X$ from this range, the range will contain only the other token, token $Y$, and
the price will move to the left of the curve. The price, as we defined it, will <strong>increase</strong>. If there&rsquo;s a price range
to the left of this one, it needs to have $X$ liquidity, and only $X$, not $Y$: it needs to provide $Y$ for our swap.
If we keep buying and rising the price, we might &ldquo;drain&rdquo; this price as well, which means buying all its $X$ tokens and
selling $Y$ tokens. Again, the price range ends up having only $Y$ token and current price moves outside of it.</p><p>Similarly, if we&rsquo;re buying $Y$ token, we move the price to the right and removing $Y$ tokens from the pool. The next
price range will only contain $Y$ tokens to satisfy our demand, and, similarly to the above scenario, will contain only
$X$ tokens if we buy all $Y$ tokens from it.</p><p>Note the interesting fact: when crossing an entire price range, it&rsquo;s liquidity is swapped from one token to another. And
if we set a very narrow price range, one that gets crossed quickly during a price move, we get a limit order! For example,
if you want to buy ETH at a lower price, you need to place a price range containing only USDC at the lower price and
wait for current price to cross it. After that, you&rsquo;ll need to remove your liquidity and get it whole converted to ETH!</p><p>I hope this didn&rsquo;t confuse you! Let&rsquo;s get to code.</p><h2 id=updating-mint-function>Updating <code>mint</code> Function
<a class=anchor href=#updating-mint-function>#</a></h2><p>To support all the kings of price ranges, we need to current price is below, inside, or above the price range specified
by user and calculate token amounts accordingly. If the price range is above the current price, we want the liquidity
to be composed of token $X$:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span><span style=color:#75715e>// src/UniswapV3Pool.sol
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>mint</span>(
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (slot0_.tick <span style=color:#f92672>&lt;</span> lowerTick) {
</span></span><span style=display:flex><span>        amount0 <span style=color:#f92672>=</span> Math.calcAmount0Delta(
</span></span><span style=display:flex><span>            TickMath.getSqrtRatioAtTick(lowerTick),
</span></span><span style=display:flex><span>            TickMath.getSqrtRatioAtTick(upperTick),
</span></span><span style=display:flex><span>            amount
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>    ...
</span></span></code></pre></div><p>When the price range includes the current price, we want both tokens in amounts proportional to the price (this is the
scenario we implemented earlier):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span>} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (slot0_.tick <span style=color:#f92672>&lt;</span> upperTick) {
</span></span><span style=display:flex><span>    amount0 <span style=color:#f92672>=</span> Math.calcAmount0Delta(
</span></span><span style=display:flex><span>        slot0_.sqrtPriceX96,
</span></span><span style=display:flex><span>        TickMath.getSqrtRatioAtTick(upperTick),
</span></span><span style=display:flex><span>        amount
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    amount1 <span style=color:#f92672>=</span> Math.calcAmount1Delta(
</span></span><span style=display:flex><span>        slot0_.sqrtPriceX96,
</span></span><span style=display:flex><span>        TickMath.getSqrtRatioAtTick(lowerTick),
</span></span><span style=display:flex><span>        amount
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    liquidity <span style=color:#f92672>=</span> LiquidityMath.addLiquidity(liquidity, <span style=color:#66d9ef>int128</span>(amount));
</span></span></code></pre></div><p>Notice that this is the only scenario where we want to update <code>liquidity</code> since the variable tracks liquidity that&rsquo;s
available immediately.</p><p>In all other cases, when the price range is below the current price, we want the range to contain only token $Y$:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    amount1 <span style=color:#f92672>=</span> Math.calcAmount1Delta(
</span></span><span style=display:flex><span>        TickMath.getSqrtRatioAtTick(lowerTick),
</span></span><span style=display:flex><span>        TickMath.getSqrtRatioAtTick(upperTick),
</span></span><span style=display:flex><span>        amount
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And that&rsquo;s it!</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#different-price-ranges>Different Price Ranges</a><ul><li><a href=#limit-orders>Limit Orders</a></li><li><a href=#updating-mint-function>Updating <code>mint</code> Function</a></li></ul></li></ul></nav></div></aside></main></body></html>