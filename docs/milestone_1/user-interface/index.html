<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="function renderKatex(element) { renderMathInElement(document.body, { delimiters: [ { left: '$$', right: '$$', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }, { left: '\\[', right: '\\]', display: true } ], throwOnError: false }); }    \[ \]  User Interface #  Finally, we made it to the final stop of this milestone–building a user interface!"><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="User Interface"><meta property="og:description" content="function renderKatex(element) { renderMathInElement(document.body, { delimiters: [ { left: '$$', right: '$$', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }, { left: '\\[', right: '\\]', display: true } ], throwOnError: false }); }    \[ \]  User Interface #  Finally, we made it to the final stop of this milestone–building a user interface!"><meta property="og:type" content="article"><meta property="og:url" content="https://uniswapv3book.com/docs/milestone_1/user-interface/"><meta property="article:section" content="docs"><title>User Interface | Uniswap V3 Book 中文版</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css integrity="sha256-gsXb0jRHzuC0wqo+0Izglh+qQOH6Nw7uT4yfAuDUa18=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.d6b0217789cab12411fda11381b98a7b8564b6410ec290ed237c4738da0a1f38.js integrity="sha256-1rAhd4nKsSQR/aETgbmKe4VktkEOwpDtI3xHONoKHzg=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Uniswap V3 Book 中文版</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li class=book-section-flat><span>Milestone 0. 简介</span><ul><li><a href=/docs/introduction/introduction-to-markets/>交易市场简介</a></li><li><a href=/docs/introduction/constant-function-market-maker/>恒定函数做市商(CFMM)</a></li><li><a href=/docs/introduction/uniswap-v3/>Uniswap V3</a></li><li><a href=/docs/introduction/dev-environment/>开发环境</a></li></ul></li><li class=book-section-flat><span>Milestone 1. First Swap</span><ul><li><a href=/docs/milestone_1/introduction/>Introduction</a></li><li><a href=/docs/milestone_1/calculating-liquidity/>Calculating Liquidity</a></li><li><a href=/docs/milestone_1/providing-liquidity/>Providing Liquidity</a></li><li><a href=/docs/milestone_1/first-swap/>First Swap</a></li><li><a href=/docs/milestone_1/manager-contract/>Manager Contract</a></li><li><a href=/docs/milestone_1/deployment/>Deployment</a></li><li><a href=/docs/milestone_1/user-interface/ class=active>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 2. Second Swap</span><ul><li><a href=/docs/milestone_2/introduction/>Introduction</a></li><li><a href=/docs/milestone_2/output-amount-calculation/>Output Amount Calculation</a></li><li><a href=/docs/milestone_2/math-in-solidity/>Math in Solidity</a></li><li><a href=/docs/milestone_2/tick-bitmap-index/>Tick Bitmap Index</a></li><li><a href=/docs/milestone_2/generalize-minting/>Generalize Minting</a></li><li><a href=/docs/milestone_2/generalize-swapping/>Generalize Swapping</a></li><li><a href=/docs/milestone_2/quoter-contract/>Quoter Contract</a></li><li><a href=/docs/milestone_2/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 3. Cross-tick Swaps</span><ul><li><a href=/docs/milestone_3/introduction/>Introduction</a></li><li><a href=/docs/milestone_3/different-ranges/>Different Price Ranges</a></li><li><a href=/docs/milestone_3/cross-tick-swaps/>Cross-Tick Swaps</a></li><li><a href=/docs/milestone_3/slippage-protection/>Slippage Protection</a></li><li><a href=/docs/milestone_3/liquidity-calculation/>Liquidity Calculation</a></li><li><a href=/docs/milestone_3/more-on-fixed-point-numbers/>A Little Bit More on Fixed-point Numbers</a></li><li><a href=/docs/milestone_3/flash-loans/>Flash Loans</a></li><li><a href=/docs/milestone_3/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 4. Multi-pool Swaps</span><ul><li><a href=/docs/milestone_4/introduction/>Introduction</a></li><li><a href=/docs/milestone_4/factory-contract/>Factory Contract</a></li><li><a href=/docs/milestone_4/path/>Swap Path</a></li><li><a href=/docs/milestone_4/multi-pool-swaps/>Multi-pool Swaps</a></li><li><a href=/docs/milestone_4/user-interface/>User Interface</a></li><li><a href=/docs/milestone_4/tick-rounding/>Tick Rounding</a></li></ul></li><li class=book-section-flat><span>Milestone 5. Fees and Price Oracle</span><ul><li><a href=/docs/milestone_5/introduction/>Introduction</a></li><li><a href=/docs/milestone_5/swap-fees/>Swap Fees</a></li><li><a href=/docs/milestone_5/flash-loan-fees/>Flash Loan Fees</a></li><li><a href=/docs/milestone_5/protocol-fees/>Protocol Fees</a></li><li><a href=/docs/milestone_5/price-oracle/>Price Oracle</a></li><li><a href=/docs/milestone_5/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 6: NFT positions</span><ul><li><a href=/docs/milestone_6/introduction/>Introduction</a></li><li><a href=/docs/milestone_6/erc721-overview/>ERC721 Overview</a></li><li><a href=/docs/milestone_6/nft-manager/>NFT Manager</a></li><li><a href=/docs/milestone_6/nft-renderer/>NFT Renderer</a></li></ul></li><li class=book-section-flat><span>补充资料</span><ul><li><a href=/docs/reference/dictionary/>中英名词对照</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>User Interface</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#user-interface>User Interface</a><ul><li><a href=#overview-of-tools>Overview of Tools</a><ul><li><a href=#what-is-metamask>What is MetaMask?</a></li><li><a href=#convenience-libraries>Convenience Libraries</a></li></ul></li><li><a href=#workflows>Workflows</a><ul><li><a href=#connecting-to-local-node>Connecting to Local Node</a></li><li><a href=#connecting-to-metamask>Connecting to MetaMask</a></li><li><a href=#providing-liquidity>Providing Liquidity</a></li><li><a href=#swapping-tokens>Swapping Tokens</a></li><li><a href=#subscribing-to-changes>Subscribing to Changes</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><link rel=stylesheet href=/katex/katex.min.css><script>function renderKatex(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})}</script><script defer src=/katex/katex.min.js></script>
<script defer src=/katex/auto-render.min.js onload=renderKatex(document.body)></script><span>
\[ \]</span><h1 id=user-interface>User Interface
<a class=anchor href=#user-interface>#</a></h1><p>Finally, we made it to the final stop of this milestone–building a user interface!</p><p><img src=/images/milestone_1/ui.png alt="Interface of the UI app"></p><p>Since building a front-end app is not the main goal of this book, I won&rsquo;t show how to build such an app from scratch.
Instead, I&rsquo;ll show how to use MetaMask to interact with smart contracts.</p><blockquote><p>If you want to experiment with the app and run it locally, you can fund it in the <a href=https://github.com/Jeiwan/uniswapv3-code/tree/milestone_1/ui>ui</a>
folder in the code repo. This is a simple React app, to run it locally set contracts addresses in <code>App.js</code> and run <code>yarn start</code>.</p></blockquote><h2 id=overview-of-tools>Overview of Tools
<a class=anchor href=#overview-of-tools>#</a></h2><h3 id=what-is-metamask>What is MetaMask?
<a class=anchor href=#what-is-metamask>#</a></h3><p>MetaMask is an Ethereum wallet implemented as a browser extension. It creates and stores private keys, shows token
balances, allows to connect to different networks, sends, and receives ether and tokens–everything a wallet has to do.</p><p>Besides that, MetaMask acts as a signer and a provider. As a provider, it connects to an Ethereum node and provides an
interface to use its JSON-RPC API. As a signer, it provides an interface for secure transaction signing, thus it can
be used to sign any transaction using a private key from the wallet.</p><p><img src=/images/milestone_1/metamask.png alt="How MetaMask works"></p><h3 id=convenience-libraries>Convenience Libraries
<a class=anchor href=#convenience-libraries>#</a></h3><p>MetaMask, however, doesn&rsquo;t provide much functionality: it can only manage accounts and send raw transactions. We need
another library that will make interaction with contracts easy. And we also want a set of utilities that will make our
life easier when handling EVM-specific data (ABI encoding/decoding, big numbers handling, etc.).</p><p>There are multiple such libraries. The two most popular ones are: <a href=https://github.com/ChainSafe/web3.js>web3.js</a> and
<a href=https://github.com/ethers-io/ethers.js/>ethers.js</a>. Picking either of them is a matter of personal preference. To me,
Ethers.js seems to have a cleaner contract interaction interface, so I&rsquo;ll pick it.</p><h2 id=workflows>Workflows
<a class=anchor href=#workflows>#</a></h2><p>Let&rsquo;s now see how we can implement interaction scenarios using MetaMask + Ethers.js.</p><h3 id=connecting-to-local-node>Connecting to Local Node
<a class=anchor href=#connecting-to-local-node>#</a></h3><p>To send transactions and fetch blockchain data, MetaMask connects to an Ethereum node. To interact with our contracts,
we need to connect to the local Anvil node. To do this, open MetaMask, click on the list of networks, click &ldquo;Add Network&rdquo;,
and add a network with RPC URL <code>http://localhost:8545</code>. It&rsquo;ll automatically detect the chain ID (31337 in the case of Anvil).</p><p>After connecting to the local node, we need to import our private key. In MetaMask, click on the list of addresses, click
&ldquo;Import Account&rdquo;, and paste the private key of the address you picked before deploying the contracts. After that, go to
the assets list and import the addresses of the two tokens. Now you should see balances of the tokens in MetaMask.</p><blockquote><p>MetaMask is still somewhat bugged. One problem I struggled with is that it caches blockchain state when connected to
<code>localhost</code>. Because of this, when restarting the node, you might see old token balances and state. To fix this, go to
the advanced settings and click &ldquo;Reset Account&rdquo;. You&rsquo;ll need to do this each time after restarting the node.</p></blockquote><h3 id=connecting-to-metamask>Connecting to MetaMask
<a class=anchor href=#connecting-to-metamask>#</a></h3><p>Not every website is allowed to get access to your address in MetaMask. A website first needs to connect to MetaMask.
When a new website is connecting to MetaMask, you&rsquo;ll see a window that asks for permissions.</p><p>Here&rsquo;s how to connect to MetaMask from a front-end app:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// ui/src/contexts/MetaMask.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>connect</span> <span style=color:#f92672>=</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>typeof</span> (window.<span style=color:#a6e22e>ethereum</span>) <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;undefined&#39;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>setStatus</span>(<span style=color:#e6db74>&#39;not_installed&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Promise.<span style=color:#a6e22e>all</span>([
</span></span><span style=display:flex><span>    window.<span style=color:#a6e22e>ethereum</span>.<span style=color:#a6e22e>request</span>({ <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;eth_requestAccounts&#39;</span> }),
</span></span><span style=display:flex><span>    window.<span style=color:#a6e22e>ethereum</span>.<span style=color:#a6e22e>request</span>({ <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;eth_chainId&#39;</span> }),
</span></span><span style=display:flex><span>  ]).<span style=color:#a6e22e>then</span>(<span style=color:#66d9ef>function</span> ([<span style=color:#a6e22e>accounts</span>, <span style=color:#a6e22e>chainId</span>]) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setAccount</span>(<span style=color:#a6e22e>accounts</span>[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setChain</span>(<span style=color:#a6e22e>chainId</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setStatus</span>(<span style=color:#e6db74>&#39;connected&#39;</span>);
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>    .<span style=color:#66d9ef>catch</span>(<span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>error</span>)
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>window.ethereum</code> is an object provided by MetaMask, it&rsquo;s the interface to communicate with MetaMask. If it&rsquo;s undefined,
MetaMask is not installed. If it&rsquo;s defined, we can send two requests to MetaMask: <code>eth_requestAccounts</code> and <code>eth_chainId</code>.
In fact, <code>eth_requestAccounts</code> connects a website to MetaMask. It basically queries an address from MetaMask, and MetaMask
asks for permission from user. User will be able to choose which addresses to give access to.</p><p><code>eth_chainId</code> will ask for the chain ID of the node MetaMask is connected to. After obtaining an address and chain ID,
it&rsquo;s a good practice to display them in the interface:</p><p><img src=/images/milestone_1/ui_metamask_connected.png alt="MetaMask is connected"></p><h3 id=providing-liquidity>Providing Liquidity
<a class=anchor href=#providing-liquidity>#</a></h3><p>To provide liquidity into the pool, we need to build a form that asks the user to type the amounts they want to deposit.
After clicking &ldquo;Submit&rdquo;, the app will build a transaction that calls <code>mint</code> in the manager contract and provides the
amounts chosen by users. Let&rsquo;s see how to do this.</p><p>Ether.js provides <code>Contract</code> interface to interact with contracts. It makes our life much easier, since it takes on the job
of encoding function parameters, creating a valid transaction, and handing it over to MetaMask. For us, calling contracts
looks like calling asynchronous methods on a JS object.</p><p>Let&rsquo;s see how to create an instance of <code>Contracts</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>token0</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>Contract</span>(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>token0Address</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>ABIs</span>.<span style=color:#a6e22e>ERC20</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>providers</span>.<span style=color:#a6e22e>Web3Provider</span>(window.<span style=color:#a6e22e>ethereum</span>).<span style=color:#a6e22e>getSigner</span>()
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>A <code>Contract</code> instance is an address and the ABI of the contract deployed at this address. The ABI is needed to interact
with the contract. The third parameter is the signer interface provided by MetaMask–it&rsquo;s used by the JS contract instance
to sign transactions via MetaMask.</p><p>Now, let&rsquo;s add a function for adding liquidity to the pool:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>addLiquidity</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>account</span>, { <span style=color:#a6e22e>token0</span>, <span style=color:#a6e22e>token1</span>, <span style=color:#a6e22e>manager</span> }, { <span style=color:#a6e22e>managerAddress</span>, <span style=color:#a6e22e>poolAddress</span> }) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>amount0</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>parseEther</span>(<span style=color:#e6db74>&#34;0.998976618347425280&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>amount1</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>parseEther</span>(<span style=color:#e6db74>&#34;5000&#34;</span>); <span style=color:#75715e>// 5000 USDC
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>lowerTick</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>84222</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>upperTick</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>86129</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>liquidity</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>BigNumber</span>.<span style=color:#a6e22e>from</span>(<span style=color:#e6db74>&#34;1517882343751509868544&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>extra</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>defaultAbiCoder</span>.<span style=color:#a6e22e>encode</span>(
</span></span><span style=display:flex><span>    [<span style=color:#e6db74>&#34;address&#34;</span>, <span style=color:#e6db74>&#34;address&#34;</span>, <span style=color:#e6db74>&#34;address&#34;</span>],
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>token0</span>.<span style=color:#a6e22e>address</span>, <span style=color:#a6e22e>token1</span>.<span style=color:#a6e22e>address</span>, <span style=color:#a6e22e>account</span>]
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><p>The first thing to do is to prepare the parameters. We use the same values we calculated earlier.</p><p>Next, we allow the manager contract to take our tokens. First, we check the current allowances:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>Promise.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>  [
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>token0</span>.<span style=color:#a6e22e>allowance</span>(<span style=color:#a6e22e>account</span>, <span style=color:#a6e22e>managerAddress</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>token1</span>.<span style=color:#a6e22e>allowance</span>(<span style=color:#a6e22e>account</span>, <span style=color:#a6e22e>managerAddress</span>)
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>Then, we check if either of them is enough to transfer a corresponding amount of tokens. If not, we&rsquo;re sending an <code>approve</code>
transaction, which asks the user to approve spending of a specific amount to the manager contract. After ensuring that
the user has approved full amounts, we call <code>manager.mint</code> to add liquidity:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>.<span style=color:#a6e22e>then</span>(([<span style=color:#a6e22e>allowance0</span>, <span style=color:#a6e22e>allowance1</span>]) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> Promise.<span style=color:#a6e22e>resolve</span>()
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>then</span>(() =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>allowance0</span>.<span style=color:#a6e22e>lt</span>(<span style=color:#a6e22e>amount0</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>token0</span>.<span style=color:#a6e22e>approve</span>(<span style=color:#a6e22e>managerAddress</span>, <span style=color:#a6e22e>amount0</span>).<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>tx</span> =&gt; <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>wait</span>())
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>then</span>(() =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>allowance1</span>.<span style=color:#a6e22e>lt</span>(<span style=color:#a6e22e>amount1</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>token1</span>.<span style=color:#a6e22e>approve</span>(<span style=color:#a6e22e>managerAddress</span>, <span style=color:#a6e22e>amount1</span>).<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>tx</span> =&gt; <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>wait</span>())
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>then</span>(() =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>manager</span>.<span style=color:#a6e22e>mint</span>(<span style=color:#a6e22e>poolAddress</span>, <span style=color:#a6e22e>lowerTick</span>, <span style=color:#a6e22e>upperTick</span>, <span style=color:#a6e22e>liquidity</span>, <span style=color:#a6e22e>extra</span>)
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>tx</span> =&gt; <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>wait</span>())
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>then</span>(() =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>alert</span>(<span style=color:#e6db74>&#39;Liquidity added!&#39;</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><blockquote><p><code>lt</code> is a method of <a href=https://docs.ethers.io/v5/api/utils/bignumber/>BigNumber</a>. Ethers.js uses BigNumber to represent
<code>uint256</code> type, for which JavaScript <a href=https://docs.ethers.io/v5/api/utils/bignumber/#BigNumber--notes-safenumbers>doesn&rsquo;t have enough precision</a>.
This is one of the reasons why we want a convenience library.</p></blockquote><p>This is pretty much similar to the test contract, besides the allowances part.</p><p><code>token0</code>, <code>token1</code>, and <code>manager</code> in the above code are instances of <code>Contract</code>. <code>approve</code> and <code>mint</code> are contract
functions, which were generated dynamically from the ABIs we provided when instantiated the contracts. When calling these
methods, Ethers.js:</p><ol><li>encodes function parameters;</li><li>builds a transaction;</li><li>passes the transaction to MetaMask and asks to sign it; user sees a MetaMask window and presses &ldquo;Confirm&rdquo;;</li><li>sends the transaction to the node MetaMask is connected to;</li><li>returns a transaction object with full information about the sent transaction.</li></ol><p>The transaction object also contains <code>wait</code> function, which we call to wait for a transaction to be mined–this allows
us to wait for a transaction to be successfully executed before sending another.</p><blockquote><p>Ethereum requires a strict order of transaction. Remember the nonce? It&rsquo;s an account-wide index of transactions, sent
by this account. Every new transaction increases this index, and Ethereum won&rsquo;t mine a transaction until a previous
transaction (one with a smaller nonce) was mined.</p></blockquote><h3 id=swapping-tokens>Swapping Tokens
<a class=anchor href=#swapping-tokens>#</a></h3><p>To swap tokens, we use the same pattern: get parameters from the user, check allowance, call <code>swap</code> on the manager.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>swap</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>amountIn</span>, <span style=color:#a6e22e>account</span>, { <span style=color:#a6e22e>tokenIn</span>, <span style=color:#a6e22e>manager</span>, <span style=color:#a6e22e>token0</span>, <span style=color:#a6e22e>token1</span> }, { <span style=color:#a6e22e>managerAddress</span>, <span style=color:#a6e22e>poolAddress</span> }) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>amountInWei</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>parseEther</span>(<span style=color:#a6e22e>amountIn</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>extra</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>defaultAbiCoder</span>.<span style=color:#a6e22e>encode</span>(
</span></span><span style=display:flex><span>    [<span style=color:#e6db74>&#34;address&#34;</span>, <span style=color:#e6db74>&#34;address&#34;</span>, <span style=color:#e6db74>&#34;address&#34;</span>],
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>token0</span>.<span style=color:#a6e22e>address</span>, <span style=color:#a6e22e>token1</span>.<span style=color:#a6e22e>address</span>, <span style=color:#a6e22e>account</span>]
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>tokenIn</span>.<span style=color:#a6e22e>allowance</span>(<span style=color:#a6e22e>account</span>, <span style=color:#a6e22e>managerAddress</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>allowance</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>allowance</span>.<span style=color:#a6e22e>lt</span>(<span style=color:#a6e22e>amountInWei</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>tokenIn</span>.<span style=color:#a6e22e>approve</span>(<span style=color:#a6e22e>managerAddress</span>, <span style=color:#a6e22e>amountInWei</span>).<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>tx</span> =&gt; <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>wait</span>())
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>then</span>(() =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>manager</span>.<span style=color:#a6e22e>swap</span>(<span style=color:#a6e22e>poolAddress</span>, <span style=color:#a6e22e>extra</span>).<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>tx</span> =&gt; <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>wait</span>())
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>then</span>(() =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>alert</span>(<span style=color:#e6db74>&#39;Swap succeeded!&#39;</span>);
</span></span><span style=display:flex><span>    }).<span style=color:#66d9ef>catch</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>alert</span>(<span style=color:#e6db74>&#39;Failed!&#39;</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The only new thing here is <code>ethers.utils.parseEther()</code> function, which we use to convert numbers to wei, the smallest
unit in Ethereum.</p><h3 id=subscribing-to-changes>Subscribing to Changes
<a class=anchor href=#subscribing-to-changes>#</a></h3><p>For a decentralized application, it&rsquo;s important to reflect the current blockchain state. For example, in the case of a
decentralized exchange, it&rsquo;s critical to properly calculate swap prices based on current pool reserves; outdated data
can cause slippage and make a swap transaction fail.</p><p>While developing the pool contract, we learned about events, which act as blockchain data indexes: whenever smart contract
state is modified, it&rsquo;s a good practice to emit an event since events are indexed for quick search. What we&rsquo;re going to
do now, is to subscribe to contract events to keep our front-end app updated. Let&rsquo;s build an event feed!</p><p>If you checked the ABI file as I recommended earlier, you saw that it also contains description of events: event
name and its fields. Well, <a href=https://docs.ethers.io/v5/api/contract/contract/#Contract--events>Ether.js parses them</a> and
provides an interface to subscribe to new events. Let&rsquo;s see how this works.</p><p>To subscribe to events, we&rsquo;ll use <code>on(EVENT_NAME, handler)</code> function. The callback receives all the fields of the event
and the event itself as parameters:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>subscribeToEvents</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>pool</span>, <span style=color:#a6e22e>callback</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;Mint&#34;</span>, (<span style=color:#a6e22e>sender</span>, <span style=color:#a6e22e>owner</span>, <span style=color:#a6e22e>tickLower</span>, <span style=color:#a6e22e>tickUpper</span>, <span style=color:#a6e22e>amount</span>, <span style=color:#a6e22e>amount0</span>, <span style=color:#a6e22e>amount1</span>, <span style=color:#a6e22e>event</span>) =&gt; <span style=color:#a6e22e>callback</span>(<span style=color:#a6e22e>event</span>));
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;Swap&#34;</span>, (<span style=color:#a6e22e>sender</span>, <span style=color:#a6e22e>recipient</span>, <span style=color:#a6e22e>amount0</span>, <span style=color:#a6e22e>amount1</span>, <span style=color:#a6e22e>sqrtPriceX96</span>, <span style=color:#a6e22e>liquidity</span>, <span style=color:#a6e22e>tick</span>, <span style=color:#a6e22e>event</span>) =&gt; <span style=color:#a6e22e>callback</span>(<span style=color:#a6e22e>event</span>));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To filter and fetch previous events, we can use <code>queryFilter</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>Promise.<span style=color:#a6e22e>all</span>([
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>queryFilter</span>(<span style=color:#e6db74>&#34;Mint&#34;</span>, <span style=color:#e6db74>&#34;earliest&#34;</span>, <span style=color:#e6db74>&#34;latest&#34;</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>queryFilter</span>(<span style=color:#e6db74>&#34;Swap&#34;</span>, <span style=color:#e6db74>&#34;earliest&#34;</span>, <span style=color:#e6db74>&#34;latest&#34;</span>),
</span></span><span style=display:flex><span>]).<span style=color:#a6e22e>then</span>(([<span style=color:#a6e22e>mints</span>, <span style=color:#a6e22e>swaps</span>]) =&gt; {
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>You probably noticed that some event fields are marked as <code>indexed</code>–such fields are indexed by Ethereum nodes, which lets
search events by specific values in such fields. For example, the <code>Swap</code> event has <code>sender</code> and <code>recipient</code> fields
indexed, so we can search by swap sender and recipient. And again, Ethere.js makes this easier:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>swapFilter</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>filters</span>.<span style=color:#a6e22e>Swap</span>(<span style=color:#a6e22e>sender</span>, <span style=color:#a6e22e>recipient</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>swaps</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>queryFilter</span>(<span style=color:#a6e22e>swapFilter</span>, <span style=color:#a6e22e>fromBlock</span>, <span style=color:#a6e22e>toBlock</span>);
</span></span></code></pre></div><hr><p>And that&rsquo;s it! We&rsquo;re done with milestone 1!</p><p style=font-size:3rem;text-align:center>🎉🍾🍾🍾🎉</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#user-interface>User Interface</a><ul><li><a href=#overview-of-tools>Overview of Tools</a><ul><li><a href=#what-is-metamask>What is MetaMask?</a></li><li><a href=#convenience-libraries>Convenience Libraries</a></li></ul></li><li><a href=#workflows>Workflows</a><ul><li><a href=#connecting-to-local-node>Connecting to Local Node</a></li><li><a href=#connecting-to-metamask>Connecting to MetaMask</a></li><li><a href=#providing-liquidity>Providing Liquidity</a></li><li><a href=#swapping-tokens>Swapping Tokens</a></li><li><a href=#subscribing-to-changes>Subscribing to Changes</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>