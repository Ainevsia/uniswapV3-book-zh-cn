<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="function renderKatex(element) { renderMathInElement(document.body, { delimiters: [ { left: '$$', right: '$$', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }, { left: '\\[', right: '\\]', display: true } ], throwOnError: false }); }    \[ \]  Uniswap V3简介 #   本章节主要讲述了Uniswap V3白皮书中的内容。同样，假设你没有理解本章的所有概念也没有关系，我们在后面章节直接看代码可能会更清晰。
 为了更好地理解Uniswap V3的创新之处在哪里，我们首先来看Uniswap V2的缺点有哪些。
Uniswap V2使用AMM机制实现了一个通用的交易市场。然而，并不是所有的交易对都是平等的，交易对可以根据价格的波动性分为以下两类
 价格波动性为中等或高的代币对。这一类包含绝大多数的代币，因为绝大多数代币并没有锚定(pegged to)到某些东西，因此其价格随着市场波动而波动。 价格波动性低的代币对。这一类包含了有锚定的代币，主要为稳定币：USDT/USDC，USDC/DAI，USDT/DAI等等。也包括ETH/stETH，ETH/rETH（一些wrapped ETH）等类型。  这些类对于我们称作“流动性池配置”的概念有不同的要求。最主要的区别在于，锚定代币对需要非常高的流动性来降低大额交易对其的影响。USDC与USDT的价格必须保持在1附近，无论我要买卖多大数目的代币。由于Uniswap V2的通用AMM算法对于稳定币交易并没有很好的适配，其他的AMM（主要是Curve）则在稳定币交易中更加流行。"><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Uniswap V3"><meta property="og:description" content="function renderKatex(element) { renderMathInElement(document.body, { delimiters: [ { left: '$$', right: '$$', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }, { left: '\\[', right: '\\]', display: true } ], throwOnError: false }); }    \[ \]  Uniswap V3简介 #   本章节主要讲述了Uniswap V3白皮书中的内容。同样，假设你没有理解本章的所有概念也没有关系，我们在后面章节直接看代码可能会更清晰。
 为了更好地理解Uniswap V3的创新之处在哪里，我们首先来看Uniswap V2的缺点有哪些。
Uniswap V2使用AMM机制实现了一个通用的交易市场。然而，并不是所有的交易对都是平等的，交易对可以根据价格的波动性分为以下两类
 价格波动性为中等或高的代币对。这一类包含绝大多数的代币，因为绝大多数代币并没有锚定(pegged to)到某些东西，因此其价格随着市场波动而波动。 价格波动性低的代币对。这一类包含了有锚定的代币，主要为稳定币：USDT/USDC，USDC/DAI，USDT/DAI等等。也包括ETH/stETH，ETH/rETH（一些wrapped ETH）等类型。  这些类对于我们称作“流动性池配置”的概念有不同的要求。最主要的区别在于，锚定代币对需要非常高的流动性来降低大额交易对其的影响。USDC与USDT的价格必须保持在1附近，无论我要买卖多大数目的代币。由于Uniswap V2的通用AMM算法对于稳定币交易并没有很好的适配，其他的AMM（主要是Curve）则在稳定币交易中更加流行。"><meta property="og:type" content="article"><meta property="og:url" content="https://uniswapv3book.com/docs/introduction/uniswap-v3/"><meta property="article:section" content="docs"><title>Uniswap V3 | Uniswap V3 Book 中文版</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css integrity="sha256-gsXb0jRHzuC0wqo+0Izglh+qQOH6Nw7uT4yfAuDUa18=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.d6b0217789cab12411fda11381b98a7b8564b6410ec290ed237c4738da0a1f38.js integrity="sha256-1rAhd4nKsSQR/aETgbmKe4VktkEOwpDtI3xHONoKHzg=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Uniswap V3 Book 中文版</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li class=book-section-flat><span>Milestone 0. 简介</span><ul><li><a href=/docs/introduction/introduction-to-markets/>交易市场简介</a></li><li><a href=/docs/introduction/constant-function-market-maker/>恒定函数做市商(CFMM)</a></li><li><a href=/docs/introduction/uniswap-v3/ class=active>Uniswap V3</a></li><li><a href=/docs/introduction/dev-environment/>开发环境</a></li></ul></li><li class=book-section-flat><span>Milestone 1. First Swap</span><ul><li><a href=/docs/milestone_1/introduction/>Introduction</a></li><li><a href=/docs/milestone_1/calculating-liquidity/>Calculating Liquidity</a></li><li><a href=/docs/milestone_1/providing-liquidity/>Providing Liquidity</a></li><li><a href=/docs/milestone_1/first-swap/>First Swap</a></li><li><a href=/docs/milestone_1/manager-contract/>Manager Contract</a></li><li><a href=/docs/milestone_1/deployment/>Deployment</a></li><li><a href=/docs/milestone_1/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 2. Second Swap</span><ul><li><a href=/docs/milestone_2/introduction/>Introduction</a></li><li><a href=/docs/milestone_2/output-amount-calculation/>Output Amount Calculation</a></li><li><a href=/docs/milestone_2/math-in-solidity/>Math in Solidity</a></li><li><a href=/docs/milestone_2/tick-bitmap-index/>Tick Bitmap Index</a></li><li><a href=/docs/milestone_2/generalize-minting/>Generalize Minting</a></li><li><a href=/docs/milestone_2/generalize-swapping/>Generalize Swapping</a></li><li><a href=/docs/milestone_2/quoter-contract/>Quoter Contract</a></li><li><a href=/docs/milestone_2/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 3. Cross-tick Swaps</span><ul><li><a href=/docs/milestone_3/introduction/>Introduction</a></li><li><a href=/docs/milestone_3/different-ranges/>Different Price Ranges</a></li><li><a href=/docs/milestone_3/cross-tick-swaps/>Cross-Tick Swaps</a></li><li><a href=/docs/milestone_3/slippage-protection/>Slippage Protection</a></li><li><a href=/docs/milestone_3/liquidity-calculation/>Liquidity Calculation</a></li><li><a href=/docs/milestone_3/more-on-fixed-point-numbers/>A Little Bit More on Fixed-point Numbers</a></li><li><a href=/docs/milestone_3/flash-loans/>Flash Loans</a></li><li><a href=/docs/milestone_3/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 4. Multi-pool Swaps</span><ul><li><a href=/docs/milestone_4/introduction/>Introduction</a></li><li><a href=/docs/milestone_4/factory-contract/>Factory Contract</a></li><li><a href=/docs/milestone_4/path/>Swap Path</a></li><li><a href=/docs/milestone_4/multi-pool-swaps/>Multi-pool Swaps</a></li><li><a href=/docs/milestone_4/user-interface/>User Interface</a></li><li><a href=/docs/milestone_4/tick-rounding/>Tick Rounding</a></li></ul></li><li class=book-section-flat><span>Milestone 5. Fees and Price Oracle</span><ul><li><a href=/docs/milestone_5/introduction/>Introduction</a></li><li><a href=/docs/milestone_5/swap-fees/>Swap Fees</a></li><li><a href=/docs/milestone_5/flash-loan-fees/>Flash Loan Fees</a></li><li><a href=/docs/milestone_5/protocol-fees/>Protocol Fees</a></li><li><a href=/docs/milestone_5/price-oracle/>Price Oracle</a></li><li><a href=/docs/milestone_5/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 6: NFT positions</span><ul><li><a href=/docs/milestone_6/introduction/>Introduction</a></li><li><a href=/docs/milestone_6/erc721-overview/>ERC721 Overview</a></li><li><a href=/docs/milestone_6/nft-manager/>NFT Manager</a></li><li><a href=/docs/milestone_6/nft-renderer/>NFT Renderer</a></li></ul></li><li class=book-section-flat><span>补充资料</span><ul><li><a href=/docs/reference/dictionary/>中英名词对照</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Uniswap V3</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#uniswap-v3简介>Uniswap V3简介</a><ul><li><a href=#集中流动性>集中流动性</a></li><li><a href=#uniswap-v3的数学原理>Uniswap V3的数学原理</a></li><li><a href=#价格>价格</a></li><li><a href=#ticks>Ticks</a></li></ul></li></ul></nav></aside></header><article class=markdown><link rel=stylesheet href=/katex/katex.min.css><script>function renderKatex(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})}</script><script defer src=/katex/katex.min.js></script>
<script defer src=/katex/auto-render.min.js onload=renderKatex(document.body)></script><span>
\[ \]</span><h1 id=uniswap-v3简介>Uniswap V3简介
<a class=anchor href=#uniswap-v3%e7%ae%80%e4%bb%8b>#</a></h1><blockquote><p>本章节主要讲述了<a href=https://uniswap.org/whitepaper-v3.pdf>Uniswap V3白皮书</a>中的内容。同样，假设你没有理解本章的所有概念也没有关系，我们在后面章节直接看代码可能会更清晰。</p></blockquote><p>为了更好地理解Uniswap V3的创新之处在哪里，我们首先来看Uniswap V2的缺点有哪些。</p><p>Uniswap V2使用AMM机制实现了一个通用的交易市场。然而，并不是所有的交易对都是平等的，交易对可以根据价格的波动性分为以下两类</p><ol><li>价格波动性为中等或高的代币对。这一类包含绝大多数的代币，因为绝大多数代币并没有锚定(pegged to)到某些东西，因此其价格随着市场波动而波动。</li><li>价格波动性低的代币对。这一类包含了有锚定的代币，主要为稳定币：USDT/USDC，USDC/DAI，USDT/DAI等等。也包括ETH/stETH，ETH/rETH（一些wrapped ETH）等类型。</li></ol><p>这些类对于我们称作“流动性池配置”的概念有不同的要求。最主要的区别在于，锚定代币对需要非常高的流动性来降低大额交易对其的影响。USDC与USDT的价格必须保持在1附近，无论我要买卖多大数目的代币。由于Uniswap V2的通用AMM算法对于稳定币交易并没有很好的适配，其他的AMM（主要是<a href=https://curve.fi>Curve</a>）则在稳定币交易中更加流行。</p><p>导致这个问题出现的原因在于，Uniswap V2池子的流动性是分布在无穷区域上的-即池子允许在任何价格的交易发生，从0到正无穷：</p><p><img src=/images/milestone_0/curve_infinite.png alt="The curve is infinite"></p><p>这听起来不是一个坏事，但事实上它导致了资本利用效率的不足。一个资产的历史价格通常是在某个区间内的，不管这个区间是大还是小。比如，ETH的历史价格大致在<span>$0.75</span>
到 <span>$4,800</span> 这个区间（数据来源<a href=https://coinmarketcap.com/currencies/ethereum/>CoinMarketCap</a>）。在今天（2022年6月，1个ETH的现货价格是<span>$1800</span>，没有人会愿意用<span>$5000</span>购买一个ETH，所以在这个点提供流动性是毫无用处的。因此，在远离当前价格区间的、永远不会达到的某个点上提供流动性是毫无意义的</p><blockquote><p>当然，我们都相信ETH的价格某天会达到$10000
（译者注：仅代表原作者观点）</p></blockquote><h2 id=集中流动性>集中流动性
<a class=anchor href=#%e9%9b%86%e4%b8%ad%e6%b5%81%e5%8a%a8%e6%80%a7>#</a></h2><p>Uniswap V3引入了 <em>集中流动性(concentrated liquidity)</em> 的概念：LP可以选择他们希望在哪个价格区间提供流动性。这个机制通过将更多的流动性提供在一个相对狭窄的价格区间，从而大大提高了资本利用效率；这也使Uniswap的使用场景更加多样化：它现在可以对于不同价格波动性的池子进行不同的配置。这就是V3相对于V2的提升点。</p><p>简单地来说，一个Uniswap V3的交易对是许多个Uniswap V2的交易对。V2与V3的区别是，在V3中，一个交易对有许多的<strong>价格区间</strong>，而每个价格区间内都有<strong>有限数量的资产</strong>。从零到正无穷的整个价格区间被划分成了许多个小的价格区间，每一个区间中都有一定数量的流动性。而更关键的点在于，在每个小的价格区间中，<strong>工作机制与Uniswap V2</strong>一样。这也是为什么说一个Uniswap V3的池子就是许多个V2的池子。</p><p>下面，我们来对这种机制进行可视化。我们并不是重新选择一个有限的曲线，而是我们把它在价格$a$ 与价格$b$ 之间的部分截取出来，认为它们是曲线的边界。更进一步，我们把曲线进行平移使得边界点落在坐标轴上，于是得到了下图：</p><p><img src=/images/milestone_0/curve_finite.png alt="Uniswap V3 price range"></p><blockquote><p>它看起来或许有点孤单， 因此Uniswap V3有许多的价格区间——这样它们就不会感到孤单了 🙂</p></blockquote><p>正如我们在前一章中讲到的那样，交易token使得价格在曲线上移动，而价格区间限制了价格点的移动。当价格移动到曲线的一端时，我们说这个池子被<strong>耗尽了</strong>：其中一种代币的资产变成了0，无法再购买这种代币（当然，仅仅指在这个价格区间内）</p><p>假设起始价格在上面途中曲线的中间点。为了到达点$a$，我们需要购买池子里所有的$y$来使得池子里的$x$最大化；为了到达点$b$，我们需要买光池子里的$x$从而使$y$最大化。在这两个点，池子里都只剩一种token。</p><blockquote><p>一个有趣的点：根据这个原理，可以利用V3的价格区间来挂限价单</p></blockquote><p>如果当前价格区间池子被耗尽将会发生什么？价格点会滑动到下一个价格区间。如果下一个价格区间不存在，这笔交易就会以部分成交而结束——我们将在本书后面的部分看到其如何实现。</p><p>下面一图展示了<a href=https://info.uniswap.org/#/pools/0x8ad599c3a0ff1de082011efddc58f1908eb6e6d8>USDC/ETH池子的流动性分布</a>:</p><p><img src=/images/milestone_0/usdceth_liquidity.png alt="Liquidity in the real USDC/ETH pool"></p><p>可以看到，大量流动性集中在现在价格的附近，而较远的价格区间中的流动性较少——这是因为LP更希望提高它们的资产利用效率。当然，整个区间也不是无穷的，在图片右侧也显示了其上界。</p><h2 id=uniswap-v3的数学原理>Uniswap V3的数学原理
<a class=anchor href=#uniswap-v3%e7%9a%84%e6%95%b0%e5%ad%a6%e5%8e%9f%e7%90%86>#</a></h2><p>在数学原理上，V3是基于V2的：它们使用了相同的底层公式，但实际上V3使用的是可以被称作<em>增强版</em>。</p><p>为了处理价格区间之间的转换，简化流动性管理，以及避免取整出现问题，V3使用了下面这些新的标识：</p><p>$$L = \sqrt{xy}$$</p><p>$$\sqrt{P} = \sqrt{\frac{y}{x}}$$</p><p>$L$ 被称作 <em>流动性数量</em>。池子中的流动性是两种token资产数量的组合。我们知道按照公式，两种代币数量乘积为$k$，因此我们可以用 $\sqrt{xy}$ 来衡量池子流动性。$L$ 实际上是 $x$ 和 $y$ 的几何平均数。</p><p>$y/x$ 是token 0相对于token 1的价格. 由于池子里两种代币的价格互为倒数，我们在计算中仅使用其中一个(Uniswap V3使用的是$y/x$)。Token 1相对于token 0的价格即为$\frac{1}{y/x}=\frac{x}{y}$。类似地， $\frac{1}{\sqrt{P}} = \frac{1}{\sqrt{y/x}} = \sqrt{\frac{x}{y}}$.</p><p>我们使用 $\sqrt{P}$ 而不是 $P$ 有以下两个原因：</p><ol><li><p>平方根计算并不精确并且会引入取整的问题。因此，更简单的方法是我们干脆就在合约中存平方根的结果，而不是在合约中计算它。（合约中并不存储$x$和$y$）</p></li><li><p>$\sqrt{P}$ 与 $L$ 之间有一个有趣的关系：$L$ 也表示了output amount的变化与$\sqrt{P}$的变化之间的关系：</p><p>$$L = \frac{\Delta y}{\Delta\sqrt{P}}$$</p></li></ol><blockquote><p>证明:
$$L = \frac{\Delta y}{\Delta\sqrt{P}}$$</p></blockquote><p>$$\sqrt{xy} = \frac{y_1 - y_0}{\sqrt{P_1} - \sqrt{P_0}}$$</p><p>$$\sqrt{xy} (\sqrt{P_1} - \sqrt{P_0}) = y_1 - y_0$$</p><p>$$\sqrt{xy} (\sqrt{\frac{y_1}{x_1}} - \sqrt{\frac{y_0}{x_0}}) = y_1 - y_0$$</p><p>$$\sqrt{y_1^2} - \sqrt{y_0^2} = y_1 - y_0$$</p><p>$$y_1 - y_0 = y_1 - y_0$$</p><p>（译者注：第四步到第五步，$\sqrt{xy} = \sqrt{x_0y_0} = \sqrt{x_1y_1}$ ）</p><h2 id=价格>价格
<a class=anchor href=#%e4%bb%b7%e6%a0%bc>#</a></h2><p>同样，我们并不需要计算准确的价格——我们可以直接计算获得的token数量。并且，由于我们在合约中并不存储$x$和$y$，我们将仅通过 $L$ 和 $\sqrt{P}$ 进行计算。</p><p>根据上文中的公式，我们能得到 $\Delta y$：</p><p>$$\Delta y = \Delta \sqrt{P} L$$</p><blockquote><p>见上述证明中的第三步。</p></blockquote><p>正如上面所说，双方的价格互为倒数。因此，$\Delta x$ 的公式为：</p><p>$$\Delta x = \Delta \frac{1}{\sqrt{P}} L$$</p><p>$L$ 和 $\sqrt{P}$ 让我们不再需要存储和更新池子资产数量。并且，我们也并不需要每次都重新计算 $\sqrt{P}$ 因为我们从上述公式可以得到 $\Delta \sqrt{P}$。</p><h2 id=ticks>Ticks
<a class=anchor href=#ticks>#</a></h2><p>正如我们前面说到的，V2中的无穷价格区间在V3中被分成了更小的价格区间，每个区间都由上下界断点进行限制。为了进行这些边界的协调，V3引入和 <em>ticks</em>。</p><p><img src=/images/milestone_0/ticks_and_ranges.png alt="Price ranges and ticks"></p><p>在V3，整个价格区间由离散的、均匀分布的ticks进行标定。每个tick有一个index和对应的价格：</p><p>$$p(i) = 1.0001^i$$</p><p>$p(i)$ 即为 tick $i$的价格. 使用1.0001的幂次作为标定有一个很好的性质：两个相邻tick之间的差距为0.01%或者<em>一个基点。</em></p><blockquote><p>基点 (1%的百分之一，或者0.01%，或者0.0001)是在金融中用来衡量百分比的一个单位。你可能在央行宣布对于利率的调整中听过基点这个名词。</p></blockquote><p>正如我们之前讨论的，Uniswap V3存储的是$\sqrt{P}$而不是$P$。所以这个公式实际上是：</p><p>$$\sqrt{p(i)} = \sqrt{1.0001}^i = 1.0001 ^{\frac{i}{2}}$$</p><p>我们得到的值大概是这样：$\sqrt{p(0)} = 1$, $\sqrt{p(1)} = \sqrt{1.0001} \approx 1.00005$, $\sqrt{p(-1)} \approx 0.99995$.</p><p>Ticks可以为正也可以为负，并且显然它不是无穷的。V3把$\sqrt{P}$ 存储为一个Q64.96类型的定点数，使用64位作为整数部分，使用96位作为小数部分。因此，价格的取值范围是$[2^{-128}, 2^{128}]$，ticks的取值范围是：</p><p>$$[log_{1.0001}2^{-128}, log_{1.0001}{2^{128}}] = [-887272, 887272]$$</p><blockquote><p>如果希望对于Uniswap V3的数学原理有更深的理解，作者推荐<a href=https://atiselsts.github.io/pdfs/uniswap-v3-liquidity-math.pdf>这篇技术文章</a>，作者为<a href=https://twitter.com/atiselsts>Atis Elsts</a></p></blockquote></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#uniswap-v3简介>Uniswap V3简介</a><ul><li><a href=#集中流动性>集中流动性</a></li><li><a href=#uniswap-v3的数学原理>Uniswap V3的数学原理</a></li><li><a href=#价格>价格</a></li><li><a href=#ticks>Ticks</a></li></ul></li></ul></nav></div></aside></main></body></html>