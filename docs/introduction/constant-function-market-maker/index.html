<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="function renderKatex(element) { renderMathInElement(document.body, { delimiters: [ { left: '$$', right: '$$', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }, { left: '\\[', right: '\\]', display: true } ], throwOnError: false }); }    \[ \]  恒定乘积做市商 (Constant Function Market Makers) #   This chapter retells the whitepaper of Uniswap V2. Understanding this math is crucial to build a Uniswap-like DEX, but it&rsquo;s totally fine if you don&rsquo;t understand everything at this stage."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="恒定乘积做市商(CFMM)"><meta property="og:description" content="function renderKatex(element) { renderMathInElement(document.body, { delimiters: [ { left: '$$', right: '$$', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }, { left: '\\[', right: '\\]', display: true } ], throwOnError: false }); }    \[ \]  恒定乘积做市商 (Constant Function Market Makers) #   This chapter retells the whitepaper of Uniswap V2. Understanding this math is crucial to build a Uniswap-like DEX, but it&rsquo;s totally fine if you don&rsquo;t understand everything at this stage."><meta property="og:type" content="article"><meta property="og:url" content="https://uniswapv3book.com/docs/introduction/constant-function-market-maker/"><meta property="article:section" content="docs"><title>恒定乘积做市商(CFMM) | Uniswap V3 Book 中文版</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css integrity="sha256-gsXb0jRHzuC0wqo+0Izglh+qQOH6Nw7uT4yfAuDUa18=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.b0360dea9154348d79406c9c19eeb0985101e9918359a842737f3d85d0ad9739.js integrity="sha256-sDYN6pFUNI15QGycGe6wmFEB6ZGDWahCc389hdCtlzk=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Uniswap V3 Book 中文版</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li class=book-section-flat><span>Milestone 0. 简介</span><ul><li><a href=/docs/introduction/introduction-to-markets/>交易市场简介</a></li><li><a href=/docs/introduction/constant-function-market-maker/ class=active>恒定乘积做市商(CFMM)</a></li><li><a href=/docs/introduction/uniswap-v3/>Uniswap V3</a></li><li><a href=/docs/introduction/dev-environment/>Development Environment</a></li></ul></li><li class=book-section-flat><span>Milestone 1. First Swap</span><ul><li><a href=/docs/milestone_1/introduction/>Introduction</a></li><li><a href=/docs/milestone_1/calculating-liquidity/>Calculating Liquidity</a></li><li><a href=/docs/milestone_1/providing-liquidity/>Providing Liquidity</a></li><li><a href=/docs/milestone_1/first-swap/>First Swap</a></li><li><a href=/docs/milestone_1/manager-contract/>Manager Contract</a></li><li><a href=/docs/milestone_1/deployment/>Deployment</a></li><li><a href=/docs/milestone_1/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 2. Second Swap</span><ul><li><a href=/docs/milestone_2/introduction/>Introduction</a></li><li><a href=/docs/milestone_2/output-amount-calculation/>Output Amount Calculation</a></li><li><a href=/docs/milestone_2/math-in-solidity/>Math in Solidity</a></li><li><a href=/docs/milestone_2/tick-bitmap-index/>Tick Bitmap Index</a></li><li><a href=/docs/milestone_2/generalize-minting/>Generalize Minting</a></li><li><a href=/docs/milestone_2/generalize-swapping/>Generalize Swapping</a></li><li><a href=/docs/milestone_2/quoter-contract/>Quoter Contract</a></li><li><a href=/docs/milestone_2/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 3. Cross-tick Swaps</span><ul><li><a href=/docs/milestone_3/introduction/>Introduction</a></li><li><a href=/docs/milestone_3/different-ranges/>Different Price Ranges</a></li><li><a href=/docs/milestone_3/cross-tick-swaps/>Cross-Tick Swaps</a></li><li><a href=/docs/milestone_3/slippage-protection/>Slippage Protection</a></li><li><a href=/docs/milestone_3/liquidity-calculation/>Liquidity Calculation</a></li><li><a href=/docs/milestone_3/more-on-fixed-point-numbers/>A Little Bit More on Fixed-point Numbers</a></li><li><a href=/docs/milestone_3/flash-loans/>Flash Loans</a></li><li><a href=/docs/milestone_3/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 4. Multi-pool Swaps</span><ul><li><a href=/docs/milestone_4/introduction/>Introduction</a></li><li><a href=/docs/milestone_4/factory-contract/>Factory Contract</a></li><li><a href=/docs/milestone_4/path/>Swap Path</a></li><li><a href=/docs/milestone_4/multi-pool-swaps/>Multi-pool Swaps</a></li><li><a href=/docs/milestone_4/user-interface/>User Interface</a></li><li><a href=/docs/milestone_4/tick-rounding/>Tick Rounding</a></li></ul></li><li class=book-section-flat><span>Milestone 5. Fees and Price Oracle</span><ul><li><a href=/docs/milestone_5/introduction/>Introduction</a></li><li><a href=/docs/milestone_5/swap-fees/>Swap Fees</a></li><li><a href=/docs/milestone_5/flash-loan-fees/>Flash Loan Fees</a></li><li><a href=/docs/milestone_5/protocol-fees/>Protocol Fees</a></li><li><a href=/docs/milestone_5/price-oracle/>Price Oracle</a></li><li><a href=/docs/milestone_5/user-interface/>User Interface</a></li></ul></li><li class=book-section-flat><span>Milestone 6: NFT positions</span><ul><li><a href=/docs/milestone_6/introduction/>Introduction</a></li><li><a href=/docs/milestone_6/erc721-overview/>ERC721 Overview</a></li><li><a href=/docs/milestone_6/nft-manager/>NFT Manager</a></li><li><a href=/docs/milestone_6/nft-renderer/>NFT Renderer</a></li></ul></li><li class=book-section-flat><span>补充资料</span><ul><li><a href=/docs/reference/dictionary/>中英名词对照</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>恒定乘积做市商(CFMM)</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#恒定乘积做市商-constant-function-market-makers>恒定乘积做市商 (Constant Function Market Makers)</a><ul><li><a href=#the-trade-function>The trade function</a></li><li><a href=#pricing>Pricing</a></li><li><a href=#the-curve>The Curve</a></li></ul></li></ul></nav></aside></header><article class=markdown><link rel=stylesheet href=/katex/katex.min.css><script>function renderKatex(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})}</script><script defer src=/katex/katex.min.js></script>
<script defer src=/katex/auto-render.min.js onload=renderKatex(document.body)></script><span>
\[ \]</span><h1 id=恒定乘积做市商-constant-function-market-makers>恒定乘积做市商 (Constant Function Market Makers)
<a class=anchor href=#%e6%81%92%e5%ae%9a%e4%b9%98%e7%a7%af%e5%81%9a%e5%b8%82%e5%95%86-constant-function-market-makers>#</a></h1><blockquote><p>This chapter retells <a href=https://uniswap.org/whitepaper.pdf>the whitepaper of Uniswap V2</a>. Understanding this math is
crucial to build a Uniswap-like DEX, but it&rsquo;s totally fine if you don&rsquo;t understand everything at this stage.</p></blockquote><p>As I mentioned in the previous section, there are different approaches to building AMM. We&rsquo;ll be focusing on and
building one specific type of AMM–Constant Function Market Maker. Don&rsquo;t be scared by the long name! At its core is a very
simple mathematical formula:</p><p>$$x * y = k$$</p><p>That&rsquo;s it, this is the AMM.</p><p>$x$ and $y$ are pool contract reserves–the amounts of tokens it currently holds. <em>k</em> is just their product, actual
value doesn&rsquo;t matter.</p><blockquote><p><strong>Why there are only two reserves, <em>x</em> and <em>y</em>?</strong><br>Each Uniswap pool can hold only two tokens. We use <em>x</em> and <em>y</em> to refer to reserves of one pool, where <em>x</em> is the reserve
of the first token and <em>y</em> is the reserve of the other token, and the order doesn&rsquo;t matter.</p></blockquote><p>The constant function formula says: <strong>after each trade, <em>k</em> must remain unchanged</strong>. When traders make trades, they
put some amount of one token into a pool (the token they want to sell) and remove some amount of the other token from the pool
(the token they want to buy). This changes the reserves of the pool, and the constant function formula says that <strong>the product</strong>
of reserves must not change. As we will see many times in this book, this simple requirement is the core algorithm of how
Uniswap works.</p><h2 id=the-trade-function>The trade function
<a class=anchor href=#the-trade-function>#</a></h2><p>Now that we know what pools are, let&rsquo;s write the formula of how trading happens in a pool:</p><p>$$(x + r\Delta x)(y - \Delta y) = k$$</p><ol><li>There&rsquo;s a pool with some amount of token 0 ($x$) and some amount of token 1 ($y$)</li><li>When we buy token 1 for token 0, we give some amount of token 0 to the pool ($\Delta x$).</li><li>The pool gives us some amount of token 1 in exchange ($\Delta y$).</li><li>The pool also takes a small fee ($r$) from the amount of token 0 we gave.</li><li>The reserve of token 0 changes ($x + r \Delta x$), and the reserve of token 1 changes as well ($y - \Delta y$).</li><li>The product of updated reserves must still equal $k$.</li></ol><blockquote><p>We&rsquo;ll use token 0 and token 1 notation for the tokens because this is how they&rsquo;re referenced in the code. At this point,
it doesn&rsquo;t matter which of them is 0 and which is 1.</p></blockquote><p>We&rsquo;re basically giving a pool some amount of token 0 and getting some amount of token 1. The job of the pool is to give
us a correct amount of token 1 calculated at a fair price. This leads us to the following conclusion: <strong>pools decide what
trade prices are</strong>.</p><h2 id=pricing>Pricing
<a class=anchor href=#pricing>#</a></h2><p>How do we calculate the prices of tokens in a pool?</p><p>Since Uniswap pools are separate smart contracts, <strong>tokens in a pool are priced in terms of each other</strong>. For example: in
a ETH/USDC pool, ETH is priced in terms of USDC and USDC is priced in terms of ETH. If 1 ETH costs 1000 USDC, then 1 USDC
costs 0.001 ETH. The same is true for any other pool, whether it&rsquo;s a stablecoin pair or not (e.g. ETH/BTC).</p><p>In the real world, everything is priced based on <a href=https://www.investopedia.com/terms/l/law-of-supply-demand.asp>the law of supply and demand</a>.
This also holds true for AMMs. We&rsquo;ll put the demand part aside for now and focus on supply.</p><p>The prices of tokens in a pool are determined by the supply of the tokens, that is by <strong>the amounts of reserves of the
tokens</strong> that the pool is holding. Token prices are simply relations of reserves:</p><p>$$P_x = \frac{y}{x}, \quad P_y=\frac{x}{y}$$</p><p>Where $P_x$ and $P_y$ are prices of tokens in terms of the other token.</p><p>Such prices are called <em>spot prices</em> and they only reflect current market prices. However, the actual price of a trade
is calculated differently. And this is where we need to bring the demand part back.</p><p>Concluding from the law of supply and demand, <strong>high demand increases the price</strong>–and this is a property we need to have
in a permissionless. We want the price be high when demand is high, and we can use pool reserves to measure the demand:
the more tokens you want to remove from a pool, the high the penalty is.</p><p>Let&rsquo;s return to the trade formula and look at it closer:</p><p>$$(x + r\Delta x)(y - \Delta y) = xy$$</p><p>As you can see, we can derive $\Delta x$ and $\Delta y$ from it, which means we can calculate the output amount of a trade
based on the input amount and vice versa:</p><p>$$\Delta y = \frac{yr\Delta x}{x + r\Delta x}$$
$$\Delta x = \frac{x \Delta y}{r(y - \Delta y)}$$</p><p>In fact, these formulas free us from calculating prices! We can always find the output amount using the $\Delta y$ formula
(when we want to sell a known amount of tokens) and we can always find the input amount using the $\Delta x$ formula (when
we want to buy a known amount of tokens). Notice that each of these formulas is a relation of reserves ($x/y$ or $y/x$)
and they also take the trade amount ($\Delta x$ in the former and $\Delta y$ in the latter) into consideration. <strong>These
are the pricing functions that respect both supply and demand</strong>. And we don&rsquo;t even need to calculate the prices!</p><blockquote><p>Here&rsquo;s how you can derive the above formulas from the trade function:
$$(x + r\Delta x)(y - \Delta y) = xy$$
$$y - \Delta y = \frac{xy}{x + r\Delta x}$$
$$-\Delta y = \frac{xy}{x + r\Delta x} - y$$
$$-\Delta y = \frac{xy - y({x + r\Delta x})}{x + r\Delta x}$$
$$-\Delta y = \frac{xy - xy - y r \Delta x}{x + r\Delta x}$$
$$-\Delta y = \frac{- y r \Delta x}{x + r\Delta x}$$
$$\Delta y = \frac{y r \Delta x}{x + r\Delta x}$$
And:
$$(x + r\Delta x)(y - \Delta y) = xy$$
$$x + r\Delta x = \frac{xy}{y - \Delta y}$$
$$r\Delta x = \frac{xy}{y - \Delta y} - x$$
$$r\Delta x = \frac{xy - x(y - \Delta y)}{y - \Delta y}$$
$$r\Delta x = \frac{xy - xy + x \Delta y}{y - \Delta y}$$
$$r\Delta x = \frac{x \Delta y}{y - \Delta y}$$
$$\Delta x = \frac{x \Delta y}{r(y - \Delta y)}$$</p></blockquote><h2 id=the-curve>The Curve
<a class=anchor href=#the-curve>#</a></h2><p>The above calculations might seem too abstract and dry. Let&rsquo;s visualize the constant product function to better understand
how it works.</p><p>When plotted, the constant product function is a quadratic hyperbola:</p><p><img src=/images/milestone_0/the_curve.png alt="The shape of the constant product formula curve"></p><p>Where axes are the pool reserves. Every trade starts at the point on the curve that corresponds to the current ratio of
reserves. To calculate the output amount, we need to find a new point on the curve, which has the $x$ coordinate of $x+\Delta x$, i.e.
current reserve of token 0 + the amount we&rsquo;re selling. The change in $y$ is the amount of token 1 we&rsquo;ll get.</p><p>Let&rsquo;s look at a concrete example:</p><p><img src=/images/milestone_0/desmos.png alt="Desmos chart example"></p><ol><li>The purple line is the curve, the axes are the reserves of a pool (notice that they&rsquo;re equal at the start price).</li><li>Start price is 1.</li><li>We&rsquo;re selling 200 of token 0. If we use only the start price, we expect to get 200 of token 1.</li><li>However, the execution price is 0.666, so we get only 133.333 of token 1!</li></ol><p>This example is from <a href=https://www.desmos.com/calculator/7wbvkts2jf>the Desmos chart</a> made by <a href=https://twitter.com/danrobinson>Dan Robinson</a>,
one of the creators of Uniswap. To build a better intuition of how it works, try making up different scenarios and
plotting them on the graph. Try different reserves, see how output amount changes when $\Delta x$ is small relative to $x$.</p><blockquote><p>As the legend goes, Uniswap was invented in Desmos.</p></blockquote><p>I bet you&rsquo;re wondering why using such a curve? It might seem like it punishes you for trading big amounts. This is true,
and this is a desirable property! The law of supply and demand tells us that when demand is high (and supply is constant)
the price is also high. And when demand is low, the price is also lower. This is how markets work. And, magically,
the constant product function implements this mechanism! Demand is defined by the amount you want to buy, and supply is the
pool reserves. When you want to buy a big amount relative to pool reserves the price is higher than when you want to
buy a smaller amount. Such a simple formula guarantees such a powerful mechanism!</p><p>Even though Uniswap doesn&rsquo;t calculate trade prices, we can still see them on the curve. Surprisingly, there are multiple
prices when making a trade:</p><ol><li>Before a trade, there&rsquo;s <em>a spot price</em>. It&rsquo;s equal to the relation of reserves, $y/x$ or $x/y$ depending on the
direction of the trade. This price is also <em>the slope of the tangent line</em> at the starting point.</li><li>After a trade, there&rsquo;s a new spot price, at a different point on the curve. And it&rsquo;s the slope of the tangent line at
this new point.</li><li>The actual price of the trade is the slope of the line connecting the two points!</li></ol><p><strong>And that&rsquo;s the whole math of Uniswap! Phew!</strong></p><p>Well, this is the math of Uniswap V2, and we&rsquo;re studying Uniswap V3. So in the next part, we&rsquo;ll see how the mathematics
of Uniswap V3 is different.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#恒定乘积做市商-constant-function-market-makers>恒定乘积做市商 (Constant Function Market Makers)</a><ul><li><a href=#the-trade-function>The trade function</a></li><li><a href=#pricing>Pricing</a></li><li><a href=#the-curve>The Curve</a></li></ul></li></ul></nav></div></aside></main></body></html>