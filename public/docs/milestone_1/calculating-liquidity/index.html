<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="\[ \] 计算流动性 # 没有流动性就无法进行交易，因此为了能够完成我们的第一笔交易，我们首先需要向池子中添加一些流动性。为了向池子合约添加流动性，我们需要知道：
一个价格区间，即LP希望他的流动性仅在这个区间上提供和被利用 提供流动性的数量，也即提供的两种代币的数量，我们需要将它们转入池子合约。 在本节中，我们会手动计算上述变量的值；在后续章节中，我们会在合约中对此进行实现。首先我们来考虑价格区间
价格区间计算 # 回忆一下上一章所讲，在Uniswap V3中，整个价格区间被划分成了ticks：每个tick对应一个价格，以及有一个编号。在我们的第一个实现中，我们的现货价格设置为1ETH对5000USDC。购买ETH会移除池子中的一部分ETH，从而使得价格变得高于5000USDC。我们希望在一个包含此价格的区间中提供流动性，并且要确保最终的价格落在这个区间内。（跨区间的交易将会在后续章节提到）。
我们需要找到3个tick：
对应现货价格的tick（1ETH-5000USDC） 提供流动性的价格区间上下界对应的tick。在这里，下界为4545u，上界为5500u。 （译者注：4545u，$4545，4545USDC均代表相同含义，在本书中可能会混合使用）
从之前的章节中我们知道下述公式：
$$\sqrt{P} = \sqrt{\frac{y}{x}}$$
由于我们把ETH作为资产$x$，USDC作为资产$y$，每个tick对应的值为：
$$\sqrt{P_c} = \sqrt{\frac{5000}{1}} = \sqrt{5000} \approx 70.71$$
$$\sqrt{P_l} = \sqrt{\frac{4545}{1}} \approx 67.42$$
$$\sqrt{P_u} = \sqrt{\frac{5500}{1}} \approx 74.16$$
在这里，$P_c$代表现货价格，$P_l$代表区间下界，$P_u$代表区间上界。
接下来，我们可以计算价格对应的ticks。使用下面公式：
$$\sqrt{P(i)}=1.0001^{\frac{i}{2}}$$
我们可以得到关于$i$的公式：
$$i = log_{\sqrt{1.0001}} \sqrt{P(i)}$$
公式中的两个根号实际上是可以消去的，但由于我们会使用$\sqrt{p}$进行计算，我们选择保留根号
这几个对应的tick分别为:
现货tick: $i_c = log_{\sqrt{1.0001}} 70.71 = 85176$ 下界tick: $i_l = log_{\sqrt{1.0001}} 67.42 = 84222$ 上界tick: $i_u = log_{\sqrt{1.0001}} 74.16 = 86129$ 计算过程使用的是Python：">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="计算流动性" />
<meta property="og:description" content="\[ \] 计算流动性 # 没有流动性就无法进行交易，因此为了能够完成我们的第一笔交易，我们首先需要向池子中添加一些流动性。为了向池子合约添加流动性，我们需要知道：
一个价格区间，即LP希望他的流动性仅在这个区间上提供和被利用 提供流动性的数量，也即提供的两种代币的数量，我们需要将它们转入池子合约。 在本节中，我们会手动计算上述变量的值；在后续章节中，我们会在合约中对此进行实现。首先我们来考虑价格区间
价格区间计算 # 回忆一下上一章所讲，在Uniswap V3中，整个价格区间被划分成了ticks：每个tick对应一个价格，以及有一个编号。在我们的第一个实现中，我们的现货价格设置为1ETH对5000USDC。购买ETH会移除池子中的一部分ETH，从而使得价格变得高于5000USDC。我们希望在一个包含此价格的区间中提供流动性，并且要确保最终的价格落在这个区间内。（跨区间的交易将会在后续章节提到）。
我们需要找到3个tick：
对应现货价格的tick（1ETH-5000USDC） 提供流动性的价格区间上下界对应的tick。在这里，下界为4545u，上界为5500u。 （译者注：4545u，$4545，4545USDC均代表相同含义，在本书中可能会混合使用）
从之前的章节中我们知道下述公式：
$$\sqrt{P} = \sqrt{\frac{y}{x}}$$
由于我们把ETH作为资产$x$，USDC作为资产$y$，每个tick对应的值为：
$$\sqrt{P_c} = \sqrt{\frac{5000}{1}} = \sqrt{5000} \approx 70.71$$
$$\sqrt{P_l} = \sqrt{\frac{4545}{1}} \approx 67.42$$
$$\sqrt{P_u} = \sqrt{\frac{5500}{1}} \approx 74.16$$
在这里，$P_c$代表现货价格，$P_l$代表区间下界，$P_u$代表区间上界。
接下来，我们可以计算价格对应的ticks。使用下面公式：
$$\sqrt{P(i)}=1.0001^{\frac{i}{2}}$$
我们可以得到关于$i$的公式：
$$i = log_{\sqrt{1.0001}} \sqrt{P(i)}$$
公式中的两个根号实际上是可以消去的，但由于我们会使用$\sqrt{p}$进行计算，我们选择保留根号
这几个对应的tick分别为:
现货tick: $i_c = log_{\sqrt{1.0001}} 70.71 = 85176$ 下界tick: $i_l = log_{\sqrt{1.0001}} 67.42 = 84222$ 上界tick: $i_u = log_{\sqrt{1.0001}} 74.16 = 86129$ 计算过程使用的是Python：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://uniswapv3book.com/docs/milestone_1/calculating-liquidity/" /><meta property="article:section" content="docs" />



<title>计算流动性 | Uniswap V3 Book 中文版</title>
<link rel="manifest" href="https://uniswapv3book.com/manifest.json">
<link rel="icon" href="https://uniswapv3book.com/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="https://uniswapv3book.com/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css" integrity="sha256-gsXb0jRHzuC0wqo&#43;0Izglh&#43;qQOH6Nw7uT4yfAuDUa18=" crossorigin="anonymous">
  <script defer src="https://uniswapv3book.com/flexsearch.min.js"></script>
  <script defer src="https://uniswapv3book.com/en.search.min.7bcb9cc1edbdbe78ffa7aeda28e09d51033768c24a465538e9da7066e43237d4.js" integrity="sha256-e8ucwe29vnj/p67aKOCdUQM3aMJKRlU46dpwZuQyN9Q=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="https://uniswapv3book.com/"><span>Uniswap V3 Book 中文版</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 0. 简介</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/introduction/introduction-to-markets/" class="">交易市场简介</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/introduction/constant-function-market-maker/" class="">恒定函数做市商(CFMM)</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/introduction/uniswap-v3/" class="">Uniswap V3</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/introduction/dev-environment/" class="">开发环境</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 1. 第一笔交易</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/introduction/" class="">简介</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/calculating-liquidity/" class="active">计算流动性</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/providing-liquidity/" class="">提供流动性</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/first-swap/" class="">第一笔交易</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/manager-contract/" class="">管理合约</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/deployment/" class="">部署合约</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/user-interface/" class="">用户界面</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 2. 第二笔交易</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/introduction/" class="">简介</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/output-amount-calculation/" class="">输出金额计算</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/math-in-solidity/" class="">Solidity中的数学运算</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/tick-bitmap-index/" class="">Tick Bitmap Index</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/generalize-minting/" class="">通用mint</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/generalize-swapping/" class="">通用swap</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/quoter-contract/" class="">报价合约</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/user-interface/" class="">用户界面</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 3. 跨tick交易</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/introduction/" class="">简介</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/different-ranges/" class="">不同价格区间</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/cross-tick-swaps/" class="">Cross-Tick Swaps</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/slippage-protection/" class="">Slippage Protection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/liquidity-calculation/" class="">Liquidity Calculation</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/more-on-fixed-point-numbers/" class="">A Little Bit More on Fixed-point Numbers</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/flash-loans/" class="">Flash Loans</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/user-interface/" class="">User Interface</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 4. Multi-pool Swaps</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_4/introduction/" class="">Introduction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_4/factory-contract/" class="">Factory Contract</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_4/path/" class="">Swap Path</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_4/multi-pool-swaps/" class="">Multi-pool Swaps</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_4/user-interface/" class="">User Interface</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_4/tick-rounding/" class="">Tick Rounding</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 5. Fees and Price Oracle</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_5/introduction/" class="">Introduction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_5/swap-fees/" class="">Swap Fees</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_5/flash-loan-fees/" class="">Flash Loan Fees</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_5/protocol-fees/" class="">Protocol Fees</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_5/price-oracle/" class="">Price Oracle</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_5/user-interface/" class="">User Interface</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 6: NFT positions</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_6/introduction/" class="">Introduction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_6/erc721-overview/" class="">ERC721 Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_6/nft-manager/" class="">NFT Manager</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_6/nft-renderer/" class="">NFT Renderer</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>补充资料</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/reference/dictionary/" class="">中英名词对照</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="https://uniswapv3book.com/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>计算流动性</strong>

  <label for="toc-control">
    
    <img src="https://uniswapv3book.com/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#计算流动性">计算流动性</a>
      <ul>
        <li><a href="#价格区间计算">价格区间计算</a></li>
        <li><a href="#token数量计算">Token数量计算</a></li>
        <li><a href="#流动性数量计算">流动性数量计算</a></li>
        <li><a href="#重新计算token数量">重新计算token数量</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown">
<link rel="stylesheet" href="https://uniswapv3book.com/katex/katex.min.css" />
<script>
  function renderKatex(element) {
    renderMathInElement(document.body, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '$', right: '$', display: false },
        { left: '\\(', right: '\\)', display: false },
        { left: '\\[', right: '\\]', display: true }
      ],
      
      throwOnError: false
    });
  }
</script>
<script defer src="https://uniswapv3book.com/katex/katex.min.js"></script>
<script defer src="https://uniswapv3book.com/katex/auto-render.min.js" onload="renderKatex(document.body)"></script><span>
  \[ \]
</span>
<h1 id="计算流动性">
  计算流动性
  <a class="anchor" href="#%e8%ae%a1%e7%ae%97%e6%b5%81%e5%8a%a8%e6%80%a7">#</a>
</h1>
<p>没有流动性就无法进行交易，因此为了能够完成我们的第一笔交易，我们首先需要向池子中添加一些流动性。为了向池子合约添加流动性，我们需要知道：</p>
<ol>
<li>一个价格区间，即LP希望他的流动性仅在这个区间上提供和被利用</li>
<li>提供流动性的数量，也即提供的两种代币的数量，我们需要将它们转入池子合约。</li>
</ol>
<p>在本节中，我们会手动计算上述变量的值；在后续章节中，我们会在合约中对此进行实现。首先我们来考虑价格区间</p>
<h2 id="价格区间计算">
  价格区间计算
  <a class="anchor" href="#%e4%bb%b7%e6%a0%bc%e5%8c%ba%e9%97%b4%e8%ae%a1%e7%ae%97">#</a>
</h2>
<p>回忆一下上一章所讲，在Uniswap V3中，整个价格区间被划分成了ticks：每个tick对应一个价格，以及有一个编号。在我们的第一个实现中，我们的现货价格设置为1ETH对5000USDC。购买ETH会移除池子中的一部分ETH，从而使得价格变得高于5000USDC。我们希望在一个包含此价格的区间中提供流动性，并且要确保最终的价格<strong>落在这个区间内</strong>。（跨区间的交易将会在后续章节提到）。</p>
<p>我们需要找到3个tick：</p>
<ol>
<li>对应现货价格的tick（1ETH-5000USDC）</li>
<li>提供流动性的价格区间上下界对应的tick。在这里，下界为4545u，上界为5500u。</li>
</ol>
<p>（译者注：4545u，$4545，4545USDC均代表相同含义，在本书中可能会混合使用）</p>
<p>从之前的章节中我们知道下述公式：</p>
<p>$$\sqrt{P} = \sqrt{\frac{y}{x}}$$</p>
<p>由于我们把ETH作为资产$x$，USDC作为资产$y$，每个tick对应的值为：</p>
<p>$$\sqrt{P_c} = \sqrt{\frac{5000}{1}} = \sqrt{5000} \approx 70.71$$</p>
<p>$$\sqrt{P_l} = \sqrt{\frac{4545}{1}} \approx 67.42$$</p>
<p>$$\sqrt{P_u} = \sqrt{\frac{5500}{1}} \approx 74.16$$</p>
<p>在这里，$P_c$代表现货价格，$P_l$代表区间下界，$P_u$代表区间上界。</p>
<p>接下来，我们可以计算价格对应的ticks。使用下面公式：</p>
<p>$$\sqrt{P(i)}=1.0001^{\frac{i}{2}}$$</p>
<p>我们可以得到关于$i$的公式：</p>
<p>$$i = log_{\sqrt{1.0001}} \sqrt{P(i)}$$</p>
<blockquote>
<p>公式中的两个根号实际上是可以消去的，但由于我们会使用$\sqrt{p}$进行计算，我们选择保留根号</p>
</blockquote>
<p>这几个对应的tick分别为:</p>
<ol>
<li>现货tick: $i_c = log_{\sqrt{1.0001}} 70.71 = 85176$</li>
<li>下界tick: $i_l = log_{\sqrt{1.0001}} 67.42 = 84222$</li>
<li>上界tick: $i_u = log_{\sqrt{1.0001}} 74.16 = 86129$</li>
</ol>
<blockquote>
<p>计算过程使用的是Python：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> math
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">price_to_tick</span>(p):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> math<span style="color:#f92672">.</span>floor(math<span style="color:#f92672">.</span>log(p, <span style="color:#ae81ff">1.0001</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>price_to_tick(<span style="color:#ae81ff">5000</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">85176</span>
</span></span></code></pre></div></blockquote>
<p>价格区间的计算就是这样！</p>
<p>最后需要提到的是，在Solidity中，Uniswap使用Q64.96来存储$\sqrt{p}$。这是一个整数位由64位表示、小数位由96位表示的定点数格式。在我们上面的计算中，价格按照浮点数形式计算：<code>70.71</code>, <code>67.42</code>, <code>74.16</code>。我们需要将它们转换成Q64.96格式，也非常简单：只需要将这个数乘以$2^{96}$，即可得到：</p>
<p>$$\sqrt{P_c} = 5602277097478614198912276234240$$</p>
<p>$$\sqrt{P_l} = 5314786713428871004159001755648$$</p>
<p>$$\sqrt{P_u} = 5875717789736564987741329162240$$</p>
<blockquote>
<p>在Python中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>q96 <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">**</span><span style="color:#ae81ff">96</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">price_to_sqrtp</span>(p):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> int(math<span style="color:#f92672">.</span>sqrt(p) <span style="color:#f92672">*</span> q96)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>price_to_sqrtp(<span style="color:#ae81ff">5000</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">5602277097478614198912276234240</span>
</span></span></code></pre></div><p>注意先进行乘法再取整，否则会损失精度</p>
</blockquote>
<h2 id="token数量计算">
  Token数量计算
  <a class="anchor" href="#token%e6%95%b0%e9%87%8f%e8%ae%a1%e7%ae%97">#</a>
</h2>
<p>接下来，我们需要决定向池子中投入多少token。答案是：越多越好。数量并没有严格定义，我们质押的数目越多，购买同样数量的ETH就会使得价格的变动越小，防止离开我们的价格区间。在开发和测试智能合约的过程中，我们可以获得任意数量的token，所以钱不是问题。</p>
<p>为了实现我们的第一笔交易，我们将会在池子中质押1ETH和5000USDC。</p>
<blockquote>
<p>要记得池子中资产数量的比例决定了现货价格。所以假设我们希望像池子中投入更多的资产而保持现货价格不变，我们投入的资产也必须满足同样的比例，例如：2ETH和10,000USDC；10ETH和50,000USDC。</p>
</blockquote>
<h2 id="流动性数量计算">
  流动性数量计算
  <a class="anchor" href="#%e6%b5%81%e5%8a%a8%e6%80%a7%e6%95%b0%e9%87%8f%e8%ae%a1%e7%ae%97">#</a>
</h2>
<p>接下来，我们将基于我们质押token的数量计算流动性$L$的值。这部分可能略有难度，记得跟紧！</p>
<p>根据之前我们提到过的公式，流动性数量如下计算：</p>
<p>$$L = \sqrt{xy}$$</p>
<p>然而，上述公式是用于无穷价格区间曲线的 🙂。但我们希望的是把流动性放在某个有界的价格区间，仅仅是无穷曲线的一部分。我们需要针对我们希望流动性存在的价格区间来计算对应的$L$，因此可能需要一些更复杂的计算。</p>
<p>为了计算这个价格区间的$L$，我们来回顾我们之前讨论过的一个有趣的点：价格区间可以被<strong>耗尽</strong>。我们可以将一个价格区间的某种token全部买走，使得该区间中只有另一种token：</p>
<p><img src="https://uniswapv3book.com/images/milestone_1/range_depleted.png" alt="Range depletion example" /></p>
<p>在上图中的两个边界点，区间流动性池中都只有一种token：在$a$点池子里只有ETH，在$b$点只有USDC。</p>
<p>也就是说，我们希望能够找到一个$L$，使得价格能够移动到两个端点处。我们需要足够的流动性来使得价格能够达到上下界，因此，我们会希望通过$\Delta x$和$\Delta y$的最大值来计算流动性。</p>
<p>现在我们来看一下边界点的价格。当从池子中购买ETH，价格会升高；当从池子中购买USDC（卖出ETH），价格会下跌。由于价格为$\frac{y}{x}$，所以$a$点为价格最低点，$b$点为价格最高点。</p>
<blockquote>
<p>事实上，按照公式，在这两个点的价格是没有定义的，因为池子中只有一种token，但是我们在这里只需要理解，$b$点的价格高于起始价格，$a$点价格低于起始价格即可。</p>
</blockquote>
<p>现在，我们将图中的曲线分为两部分：起始点左边和起始点右边。我们将在两边<strong>分别</strong>计算出$L$。为什么会有两个？因为池子中的两种资产分别对<strong>其中一边</strong>起作用。由于我们希望流动性均匀分布在这个区间，我们最后会选取两个$L$中较小的一个。</p>
<p>（译者注：保证需要提供的token数量不超过原始预计的token数量）</p>
<p><img src="https://uniswapv3book.com/images/milestone_1/curve_liquidity.png" alt="Liquidity on the curve" /></p>
<p>最后还需要说明的一个关键点是：<strong>新的流动性需要保证不改变现货价格</strong>。也即，它必须与现在两种资产的数量成比例。这也是为什么我们上面会计算出两个$L$-因为仅考虑一种资产，没有保证比例。我们选择较小的那个$L$来重新计算比例。</p>
<p>或许在后面小节实现代码的过程中我们会对此有更多感觉吧。现在我们来看公式</p>
<p>回忆一下， $\Delta x$ 和 $\Delta y$ 的计算公式为：</p>
<p>$$\Delta x = \Delta \frac{1}{\sqrt{P}} L$$
$$\Delta y = \Delta \sqrt{P} L$$</p>
<p>我们把上述公式中的:$\Delta \sqrt{P}$ 相关部分展开：</p>
<p>$$\Delta x = (\frac{1}{\sqrt{P_b}} - \frac{1}{\sqrt{P_c}}) L$$
$$\Delta y = (\sqrt{P_c} - \sqrt{P_a}) L$$</p>
<p>$P_a$ 是 $a$点的价格，$P_b$ 是 $b$点的价格, $P_c$ 是现货价格。</p>
<p>我们接下来根据第一个公式推导出计算$L$的公式：</p>
<p>$$\Delta x = (\frac{1}{\sqrt{P_b}} - \frac{1}{\sqrt{P_c}}) L$$
$$\Delta x = \frac{L}{\sqrt{P_b}} - \frac{L}{\sqrt{P_c}}$$
$$\Delta x = \frac{L(\sqrt{P_b} - \sqrt{P_c})}{\sqrt{P_b} \sqrt{P_c}}$$
$$L = \Delta x \frac{\sqrt{P_b} \sqrt{P_c}}{\sqrt{P_b} - \sqrt{P_c}}$$</p>
<p>从第二个公式推导:
$$\Delta y = (\sqrt{P_c} - \sqrt{P_a}) L$$
$$L = \frac{\Delta y}{\sqrt{P_c} - \sqrt{P_a}}$$</p>
<p>这就是我们的两个$L$的计算公式，跟别对应起始点两边的两段曲线:</p>
<p>$$L = \Delta x \frac{\sqrt{P_b} \sqrt{P_c}}{\sqrt{P_b} - \sqrt{P_c}}$$
$$L = \frac{\Delta y}{\sqrt{P_c} - \sqrt{P_a}}$$</p>
<p>接下来，我们把之前计算出的价格代入公式:</p>
<p>$$L = \Delta x \frac{\sqrt{P_b}\sqrt{P_c}}{\sqrt{P_b}-\sqrt{P_c}} = 1 ETH * \frac{67.42 * 70.71}{70.71 - 67.42}$$
转换成Q64.96后得到:</p>
<p>$$L = 1519437308014769733632$$</p>
<p>对于另一个$L$:
$$L = \frac{\Delta y}{\sqrt{P_c}-\sqrt{P_a}} = \frac{5000USDC}{74.16-70.71}$$
$$L = 1517882343751509868544$$</p>
<p>两者中，我们选择小的那一个</p>
<blockquote>
<p>Python计算:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sqrtp_low <span style="color:#f92672">=</span> price_to_sqrtp(<span style="color:#ae81ff">4545</span>)
</span></span><span style="display:flex;"><span>sqrtp_cur <span style="color:#f92672">=</span> price_to_sqrtp(<span style="color:#ae81ff">5000</span>)
</span></span><span style="display:flex;"><span>sqrtp_upp <span style="color:#f92672">=</span> price_to_sqrtp(<span style="color:#ae81ff">5500</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">liquidity0</span>(amount, pa, pb):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> pa <span style="color:#f92672">&gt;</span> pb:
</span></span><span style="display:flex;"><span>        pa, pb <span style="color:#f92672">=</span> pb, pa
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (amount <span style="color:#f92672">*</span> (pa <span style="color:#f92672">*</span> pb) <span style="color:#f92672">/</span> q96) <span style="color:#f92672">/</span> (pb <span style="color:#f92672">-</span> pa)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">liquidity1</span>(amount, pa, pb):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> pa <span style="color:#f92672">&gt;</span> pb:
</span></span><span style="display:flex;"><span>        pa, pb <span style="color:#f92672">=</span> pb, pa
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> amount <span style="color:#f92672">*</span> q96 <span style="color:#f92672">/</span> (pb <span style="color:#f92672">-</span> pa)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>liq0 <span style="color:#f92672">=</span> liquidity0(amount_eth, sqrtp_cur, sqrtp_upp)
</span></span><span style="display:flex;"><span>liq1 <span style="color:#f92672">=</span> liquidity1(amount_usdc, sqrtp_cur, sqrtp_low)
</span></span><span style="display:flex;"><span>liq <span style="color:#f92672">=</span> int(min(liq0, liq1))
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1517882343751509868544</span>
</span></span></code></pre></div></blockquote>
<h2 id="重新计算token数量">
  重新计算token数量
  <a class="anchor" href="#%e9%87%8d%e6%96%b0%e8%ae%a1%e7%ae%97token%e6%95%b0%e9%87%8f">#</a>
</h2>
<p>尽管我们初始选择了我们想要质押的token数目，这个数目可能并不准确。我们并不能在任何价格区间质押任何比例的token来获取流动性，因为流动性需要满足在价格区间的曲线上均匀分布。因此，尽管用户选择了其实数量，合约会对它们重新计算，所以实际的数量会略有不同（至少，由于取整的精度变化）</p>
<p>幸运的是，我们已经获得了对应的公式</p>
<p>$$\Delta x = \frac{L(\sqrt{P_b} - \sqrt{P_c})}{\sqrt{P_b} \sqrt{P_c}}$$
$$\Delta y = L(\sqrt{P_c} - \sqrt{P_a})$$</p>
<blockquote>
<p>在Python中:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calc_amount0</span>(liq, pa, pb):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> pa <span style="color:#f92672">&gt;</span> pb:
</span></span><span style="display:flex;"><span>        pa, pb <span style="color:#f92672">=</span> pb, pa
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> int(liq <span style="color:#f92672">*</span> q96 <span style="color:#f92672">*</span> (pb <span style="color:#f92672">-</span> pa) <span style="color:#f92672">/</span> pa <span style="color:#f92672">/</span> pb)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calc_amount1</span>(liq, pa, pb):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> pa <span style="color:#f92672">&gt;</span> pb:
</span></span><span style="display:flex;"><span>        pa, pb <span style="color:#f92672">=</span> pb, pa
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> int(liq <span style="color:#f92672">*</span> (pb <span style="color:#f92672">-</span> pa) <span style="color:#f92672">/</span> q96)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>amount0 <span style="color:#f92672">=</span> calc_amount0(liq, sqrtp_upp, sqrtp_cur)
</span></span><span style="display:flex;"><span>amount1 <span style="color:#f92672">=</span> calc_amount1(liq, sqrtp_low, sqrtp_cur)
</span></span><span style="display:flex;"><span>(amount0, amount1)
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> (<span style="color:#ae81ff">998976618347425408</span>, <span style="color:#ae81ff">5000000000000000000000</span>)
</span></span></code></pre></div><p>正如上述计算结果，得到的数据基本等于我们想要提供的数量，不过ETH略少一点</p>
</blockquote>
<blockquote>
<p><strong>Hint</strong>: 使用 <code>cast --from-wei AMOUNT</code> 来把wei转换成ether, 示例:<br>
<code>cast --from-wei 998976618347425280</code> 输出 <code>0.998976618347425280</code>.</p>
</blockquote>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#计算流动性">计算流动性</a>
      <ul>
        <li><a href="#价格区间计算">价格区间计算</a></li>
        <li><a href="#token数量计算">Token数量计算</a></li>
        <li><a href="#流动性数量计算">流动性数量计算</a></li>
        <li><a href="#重新计算token数量">重新计算token数量</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












