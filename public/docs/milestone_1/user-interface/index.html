<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="\[ \] 用户界面 # 现在，我们可以进行这个milestone的最后一步了——搭建一个UI！
由于搭建前端app并不是本书的主要目的，本书将不会讲解如何从头搭建一个这样的前端，而是展示如何使用MetaMask与智能合约进行交互。
如果你希望自己尝试这个app，在本地运行它，你可以在代码仓库中的 ui文件夹找到对应代码。这就是一个简单的React应用，本地运行只需要在App.js中设置合约地址，然后运行yarn start。
相关工具一览 # 什么是MetaMask？ # MetaMask是一个浏览器插件的以太坊钱包。它能够创建和存储私钥、展示账户余额、允许链接到不同网络、发送和接受以太或其他token——钱包能做的所有事情几乎都可以在其中实现。
除此之外，MetaMask还能够作为signer和provider来运行。作为provider，它链接到一个以太坊节点，并且提供一个接口来使用对应节点的JSON-RPC API。作为一个signer，它提供了一个能够进行安全交易签名的接口，因此能够使用钱包中的私钥来签名任意交易。 （译者注：signer和provider都是js库中的常用名词，因此在这里不作翻译） 常用库 # 事实上，MetaMask也并没有提供那么多的功能：它仅仅是能够管理账户和发送交易。我们需要其他一些库来使得与合约的交互更加容易，并且能更轻松地解析EVM相关的数据。
这样的库有很多，其中最流行的两个是 web3.js 和 ethers.js。选择哪一个取决于你的个人喜好。对本书作者来说，选择 Ethers.js 因为其与合约交互的接口更加清晰
工作流 # 现在，让我们看一下如何使用 MetaMask &#43; Ethers.js 来实现交互。
连接到本地节点 # 为了能够发送交易和获取区块链数据，MetaMask链接到一个以太坊节点。为了与我们的合约交互，我们需要钱包链接到本地的Anvil节点。打开MetaMask，点击网络列表——添加网络，增加一个网络，RPC URL为http://localhost:8545。钱包将会自动检测对应的chain ID（在Anvil中为31331）.
链接到本地节点之后，我们需要导入一个私钥。在MetaMask中，点击地址列表——导入账户，把之前选择的地址对应的私钥粘贴在这里。然后进入资产列表，导入两种token的地址。现在你可以在MetaMask上看到两种token的余额了。
MetaMask实际上有一些bug。一个我经常遇到的bug是，当它连接到本地节点时，它通常会缓存链状态。因此每次重启节点的时候，你有可能会看到旧的余额和状态。解决方法是：打开高级设置，点击“重置账户”。每次重启节点后你可能都需要进行这个步骤。
链接到MetaMask # 并不是每一个网站都能够访问到你在MetaMask中的地址。一个网站首先需要链接到MetaMask。当一个新的网站想要连接MetaMask时，你会看到一个弹窗来请求许可。
前端连接MetaMask的方式如下：
// ui/src/contexts/MetaMask.js const connect = () =&gt; { if (typeof (window.ethereum) === &#39;undefined&#39;) { return setStatus(&#39;not_installed&#39;); } Promise.all([ window.ethereum.request({ method: &#39;eth_requestAccounts&#39; }), window.ethereum.request({ method: &#39;eth_chainId&#39; }), ]).">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="用户界面" />
<meta property="og:description" content="\[ \] 用户界面 # 现在，我们可以进行这个milestone的最后一步了——搭建一个UI！
由于搭建前端app并不是本书的主要目的，本书将不会讲解如何从头搭建一个这样的前端，而是展示如何使用MetaMask与智能合约进行交互。
如果你希望自己尝试这个app，在本地运行它，你可以在代码仓库中的 ui文件夹找到对应代码。这就是一个简单的React应用，本地运行只需要在App.js中设置合约地址，然后运行yarn start。
相关工具一览 # 什么是MetaMask？ # MetaMask是一个浏览器插件的以太坊钱包。它能够创建和存储私钥、展示账户余额、允许链接到不同网络、发送和接受以太或其他token——钱包能做的所有事情几乎都可以在其中实现。
除此之外，MetaMask还能够作为signer和provider来运行。作为provider，它链接到一个以太坊节点，并且提供一个接口来使用对应节点的JSON-RPC API。作为一个signer，它提供了一个能够进行安全交易签名的接口，因此能够使用钱包中的私钥来签名任意交易。 （译者注：signer和provider都是js库中的常用名词，因此在这里不作翻译） 常用库 # 事实上，MetaMask也并没有提供那么多的功能：它仅仅是能够管理账户和发送交易。我们需要其他一些库来使得与合约的交互更加容易，并且能更轻松地解析EVM相关的数据。
这样的库有很多，其中最流行的两个是 web3.js 和 ethers.js。选择哪一个取决于你的个人喜好。对本书作者来说，选择 Ethers.js 因为其与合约交互的接口更加清晰
工作流 # 现在，让我们看一下如何使用 MetaMask &#43; Ethers.js 来实现交互。
连接到本地节点 # 为了能够发送交易和获取区块链数据，MetaMask链接到一个以太坊节点。为了与我们的合约交互，我们需要钱包链接到本地的Anvil节点。打开MetaMask，点击网络列表——添加网络，增加一个网络，RPC URL为http://localhost:8545。钱包将会自动检测对应的chain ID（在Anvil中为31331）.
链接到本地节点之后，我们需要导入一个私钥。在MetaMask中，点击地址列表——导入账户，把之前选择的地址对应的私钥粘贴在这里。然后进入资产列表，导入两种token的地址。现在你可以在MetaMask上看到两种token的余额了。
MetaMask实际上有一些bug。一个我经常遇到的bug是，当它连接到本地节点时，它通常会缓存链状态。因此每次重启节点的时候，你有可能会看到旧的余额和状态。解决方法是：打开高级设置，点击“重置账户”。每次重启节点后你可能都需要进行这个步骤。
链接到MetaMask # 并不是每一个网站都能够访问到你在MetaMask中的地址。一个网站首先需要链接到MetaMask。当一个新的网站想要连接MetaMask时，你会看到一个弹窗来请求许可。
前端连接MetaMask的方式如下：
// ui/src/contexts/MetaMask.js const connect = () =&gt; { if (typeof (window.ethereum) === &#39;undefined&#39;) { return setStatus(&#39;not_installed&#39;); } Promise.all([ window.ethereum.request({ method: &#39;eth_requestAccounts&#39; }), window.ethereum.request({ method: &#39;eth_chainId&#39; }), ])." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://uniswapv3book.com/docs/milestone_1/user-interface/" /><meta property="article:section" content="docs" />



<title>用户界面 | Uniswap V3 Book 中文版</title>
<link rel="manifest" href="https://uniswapv3book.com/manifest.json">
<link rel="icon" href="https://uniswapv3book.com/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="https://uniswapv3book.com/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css" integrity="sha256-gsXb0jRHzuC0wqo&#43;0Izglh&#43;qQOH6Nw7uT4yfAuDUa18=" crossorigin="anonymous">
  <script defer src="https://uniswapv3book.com/flexsearch.min.js"></script>
  <script defer src="https://uniswapv3book.com/en.search.min.7bcb9cc1edbdbe78ffa7aeda28e09d51033768c24a465538e9da7066e43237d4.js" integrity="sha256-e8ucwe29vnj/p67aKOCdUQM3aMJKRlU46dpwZuQyN9Q=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="https://uniswapv3book.com/"><span>Uniswap V3 Book 中文版</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 0. 简介</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/introduction/introduction-to-markets/" class="">交易市场简介</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/introduction/constant-function-market-maker/" class="">恒定函数做市商(CFMM)</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/introduction/uniswap-v3/" class="">Uniswap V3</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/introduction/dev-environment/" class="">开发环境</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 1. 第一笔交易</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/introduction/" class="">简介</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/calculating-liquidity/" class="">计算流动性</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/providing-liquidity/" class="">提供流动性</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/first-swap/" class="">第一笔交易</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/manager-contract/" class="">管理合约</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/deployment/" class="">部署合约</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/user-interface/" class="active">用户界面</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 2. 第二笔交易</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/introduction/" class="">简介</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/output-amount-calculation/" class="">输出金额计算</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/math-in-solidity/" class="">Solidity中的数学运算</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/tick-bitmap-index/" class="">Tick Bitmap Index</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/generalize-minting/" class="">通用mint</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/generalize-swapping/" class="">通用swap</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/quoter-contract/" class="">报价合约</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/user-interface/" class="">用户界面</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 3. 跨tick交易</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/introduction/" class="">简介</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/different-ranges/" class="">不同价格区间</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/cross-tick-swaps/" class="">Cross-Tick Swaps</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/slippage-protection/" class="">Slippage Protection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/liquidity-calculation/" class="">Liquidity Calculation</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/more-on-fixed-point-numbers/" class="">A Little Bit More on Fixed-point Numbers</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/flash-loans/" class="">Flash Loans</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/user-interface/" class="">User Interface</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 4. Multi-pool Swaps</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_4/introduction/" class="">Introduction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_4/factory-contract/" class="">Factory Contract</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_4/path/" class="">Swap Path</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_4/multi-pool-swaps/" class="">Multi-pool Swaps</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_4/user-interface/" class="">User Interface</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_4/tick-rounding/" class="">Tick Rounding</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 5. Fees and Price Oracle</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_5/introduction/" class="">Introduction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_5/swap-fees/" class="">Swap Fees</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_5/flash-loan-fees/" class="">Flash Loan Fees</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_5/protocol-fees/" class="">Protocol Fees</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_5/price-oracle/" class="">Price Oracle</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_5/user-interface/" class="">User Interface</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 6: NFT positions</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_6/introduction/" class="">Introduction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_6/erc721-overview/" class="">ERC721 Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_6/nft-manager/" class="">NFT Manager</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_6/nft-renderer/" class="">NFT Renderer</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>补充资料</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/reference/dictionary/" class="">中英名词对照</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="https://uniswapv3book.com/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>用户界面</strong>

  <label for="toc-control">
    
    <img src="https://uniswapv3book.com/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#用户界面">用户界面</a>
      <ul>
        <li><a href="#相关工具一览">相关工具一览</a>
          <ul>
            <li><a href="#什么是metamask">什么是MetaMask？</a></li>
            <li><a href="#常用库">常用库</a></li>
          </ul>
        </li>
        <li><a href="#工作流">工作流</a>
          <ul>
            <li><a href="#连接到本地节点">连接到本地节点</a></li>
            <li><a href="#链接到metamask">链接到MetaMask</a></li>
            <li><a href="#提供流动性">提供流动性</a></li>
            <li><a href="#交易token">交易Token</a></li>
            <li><a href="#订阅更新">订阅更新</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown">
<link rel="stylesheet" href="https://uniswapv3book.com/katex/katex.min.css" />
<script>
  function renderKatex(element) {
    renderMathInElement(document.body, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '$', right: '$', display: false },
        { left: '\\(', right: '\\)', display: false },
        { left: '\\[', right: '\\]', display: true }
      ],
      
      throwOnError: false
    });
  }
</script>
<script defer src="https://uniswapv3book.com/katex/katex.min.js"></script>
<script defer src="https://uniswapv3book.com/katex/auto-render.min.js" onload="renderKatex(document.body)"></script><span>
  \[ \]
</span>
<h1 id="用户界面">
  用户界面
  <a class="anchor" href="#%e7%94%a8%e6%88%b7%e7%95%8c%e9%9d%a2">#</a>
</h1>
<p>现在，我们可以进行这个milestone的最后一步了——搭建一个UI！</p>
<p><img src="https://uniswapv3book.com/images/milestone_1/ui.png" alt="Interface of the UI app" /></p>
<p>由于搭建前端app并不是本书的主要目的，本书将不会讲解如何从头搭建一个这样的前端，而是展示如何使用MetaMask与智能合约进行交互。</p>
<blockquote>
<p>如果你希望自己尝试这个app，在本地运行它，你可以在代码仓库中的 <a href="https://github.com/Jeiwan/uniswapv3-code/tree/milestone_1/ui">ui</a>文件夹找到对应代码。这就是一个简单的React应用，本地运行只需要在<code>App.js</code>中设置合约地址，然后运行<code>yarn start</code>。</p>
</blockquote>
<h2 id="相关工具一览">
  相关工具一览
  <a class="anchor" href="#%e7%9b%b8%e5%85%b3%e5%b7%a5%e5%85%b7%e4%b8%80%e8%a7%88">#</a>
</h2>
<h3 id="什么是metamask">
  什么是MetaMask？
  <a class="anchor" href="#%e4%bb%80%e4%b9%88%e6%98%afmetamask">#</a>
</h3>
<p>MetaMask是一个浏览器插件的以太坊钱包。它能够创建和存储私钥、展示账户余额、允许链接到不同网络、发送和接受以太或其他token——钱包能做的所有事情几乎都可以在其中实现。</p>
<p>除此之外，MetaMask还能够作为signer和provider来运行。作为provider，它链接到一个以太坊节点，并且提供一个接口来使用对应节点的JSON-RPC API。作为一个signer，它提供了一个能够进行安全交易签名的接口，因此能够使用钱包中的私钥来签名任意交易。
（译者注：signer和provider都是js库中的常用名词，因此在这里不作翻译）
<img src="https://uniswapv3book.com/images/milestone_1/metamask.png" alt="How MetaMask works" /></p>
<h3 id="常用库">
  常用库
  <a class="anchor" href="#%e5%b8%b8%e7%94%a8%e5%ba%93">#</a>
</h3>
<p>事实上，MetaMask也并没有提供那么多的功能：它仅仅是能够管理账户和发送交易。我们需要其他一些库来使得与合约的交互更加容易，并且能更轻松地解析EVM相关的数据。</p>
<p>这样的库有很多，其中最流行的两个是 <a href="https://github.com/ChainSafe/web3.js">web3.js</a> 和 <a href="https://github.com/ethers-io/ethers.js/">ethers.js</a>。选择哪一个取决于你的个人喜好。对本书作者来说，选择 Ethers.js 因为其与合约交互的接口更加清晰</p>
<h2 id="工作流">
  工作流
  <a class="anchor" href="#%e5%b7%a5%e4%bd%9c%e6%b5%81">#</a>
</h2>
<p>现在，让我们看一下如何使用 MetaMask + Ethers.js 来实现交互。</p>
<h3 id="连接到本地节点">
  连接到本地节点
  <a class="anchor" href="#%e8%bf%9e%e6%8e%a5%e5%88%b0%e6%9c%ac%e5%9c%b0%e8%8a%82%e7%82%b9">#</a>
</h3>
<p>为了能够发送交易和获取区块链数据，MetaMask链接到一个以太坊节点。为了与我们的合约交互，我们需要钱包链接到本地的Anvil节点。打开MetaMask，点击网络列表——添加网络，增加一个网络，RPC URL为<code>http://localhost:8545</code>。钱包将会自动检测对应的chain ID（在Anvil中为31331）.</p>
<p>链接到本地节点之后，我们需要导入一个私钥。在MetaMask中，点击地址列表——导入账户，把之前选择的地址对应的私钥粘贴在这里。然后进入资产列表，导入两种token的地址。现在你可以在MetaMask上看到两种token的余额了。</p>
<blockquote>
<p>MetaMask实际上有一些bug。一个我经常遇到的bug是，当它连接到本地节点时，它通常会缓存链状态。因此每次重启节点的时候，你有可能会看到旧的余额和状态。解决方法是：打开高级设置，点击“重置账户”。每次重启节点后你可能都需要进行这个步骤。</p>
</blockquote>
<h3 id="链接到metamask">
  链接到MetaMask
  <a class="anchor" href="#%e9%93%be%e6%8e%a5%e5%88%b0metamask">#</a>
</h3>
<p>并不是每一个网站都能够访问到你在MetaMask中的地址。一个网站首先需要链接到MetaMask。当一个新的网站想要连接MetaMask时，你会看到一个弹窗来请求许可。</p>
<p>前端连接MetaMask的方式如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// ui/src/contexts/MetaMask.js
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">connect</span> <span style="color:#f92672">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> (window.<span style="color:#a6e22e">ethereum</span>) <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;undefined&#39;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">setStatus</span>(<span style="color:#e6db74">&#39;not_installed&#39;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Promise.<span style="color:#a6e22e">all</span>([
</span></span><span style="display:flex;"><span>    window.<span style="color:#a6e22e">ethereum</span>.<span style="color:#a6e22e">request</span>({ <span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;eth_requestAccounts&#39;</span> }),
</span></span><span style="display:flex;"><span>    window.<span style="color:#a6e22e">ethereum</span>.<span style="color:#a6e22e">request</span>({ <span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;eth_chainId&#39;</span> }),
</span></span><span style="display:flex;"><span>  ]).<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span> ([<span style="color:#a6e22e">accounts</span>, <span style="color:#a6e22e">chainId</span>]) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setAccount</span>(<span style="color:#a6e22e">accounts</span>[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setChain</span>(<span style="color:#a6e22e">chainId</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setStatus</span>(<span style="color:#e6db74">&#39;connected&#39;</span>);
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>    .<span style="color:#66d9ef">catch</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">error</span>)
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>window.ethereum</code> 是MetaMask提供的一个对象，是与MetaMask进行交互的接口。如果它是 undefined，说明没有安装MetaMask。如果它是有定义的，我们向MetaMask发送两个请求：<code>eth_requestAccounts</code> 和 <code>eth_chainId</code>。事实上，<code>eth_requestAccounts</code> 把一个网站连接到MetaMask。它向MetaMask请求一个地址，之后MetaMask向用户请求许可。用户能够选择它可以连接的钱包地址。</p>
<p><code>eth_chainId</code> 会请求MetaMask连接到的节点的 chain ID
。在获取地址和chain ID之后，通常可以把它展示在前端页面：</p>
<p><img src="https://uniswapv3book.com/images/milestone_1/ui_metamask_connected.png" alt="MetaMask is connected" /></p>
<h3 id="提供流动性">
  提供流动性
  <a class="anchor" href="#%e6%8f%90%e4%be%9b%e6%b5%81%e5%8a%a8%e6%80%a7">#</a>
</h3>
<p>为了向池子中提供流动性，我们需要搭建一个表单，要求用户填入希望质押的token数量。在点击 “Submit” 之后，前端会构建一个交易调用管理合约的<code>mint</code>函数并且把用户填入的数量作为参数传递。我们来看一下这个功能如何实现。</p>
<p>Ether.js 提供了 <code>Contract</code> 接口来与合约交互。它让这个过程变得十分简单，因为它替我们完成了编码函数参数、创建一个合法交易、把数据交给MetaMask这几个步骤。对于我们来说，调用合约就像调用一个JS对象的异步方法一样。</p>
<p>让我们来看看如何建立一个 <code>Contract</code> 的实例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">token0</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ethers</span>.<span style="color:#a6e22e">Contract</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">props</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">token0Address</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">props</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ABIs</span>.<span style="color:#a6e22e">ERC20</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ethers</span>.<span style="color:#a6e22e">providers</span>.<span style="color:#a6e22e">Web3Provider</span>(window.<span style="color:#a6e22e">ethereum</span>).<span style="color:#a6e22e">getSigner</span>()
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>一个<code>Contract</code>实例是一个地址和部署在这个地址上的合约的ABI。我们需要ABI来与合约进行交互。第三个参数是由MetaMask提供的signer接口——用来让JS合约调用MetaMask签名交易。</p>
<p>现在，我们添加一个函数，来为池子增加流动性：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">addLiquidity</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">account</span>, { <span style="color:#a6e22e">token0</span>, <span style="color:#a6e22e">token1</span>, <span style="color:#a6e22e">manager</span> }, { <span style="color:#a6e22e">managerAddress</span>, <span style="color:#a6e22e">poolAddress</span> }) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">amount0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ethers</span>.<span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">parseEther</span>(<span style="color:#e6db74">&#34;0.998976618347425280&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">amount1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ethers</span>.<span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">parseEther</span>(<span style="color:#e6db74">&#34;5000&#34;</span>); <span style="color:#75715e">// 5000 USDC
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lowerTick</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">84222</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">upperTick</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">86129</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">liquidity</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ethers</span>.<span style="color:#a6e22e">BigNumber</span>.<span style="color:#a6e22e">from</span>(<span style="color:#e6db74">&#34;1517882343751509868544&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">extra</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ethers</span>.<span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">defaultAbiCoder</span>.<span style="color:#a6e22e">encode</span>(
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;address&#34;</span>, <span style="color:#e6db74">&#34;address&#34;</span>, <span style="color:#e6db74">&#34;address&#34;</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#a6e22e">token0</span>.<span style="color:#a6e22e">address</span>, <span style="color:#a6e22e">token1</span>.<span style="color:#a6e22e">address</span>, <span style="color:#a6e22e">account</span>]
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>  ...
</span></span></code></pre></div><p>第一项就是要准备参数。我们还是使用之前手动计算出来的值。</p>
<p>接下来，我们需要允许允许管理合约操作我们的token。首先检查一下现在的许可情况：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>Promise.<span style="color:#a6e22e">all</span>(
</span></span><span style="display:flex;"><span>  [
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">token0</span>.<span style="color:#a6e22e">allowance</span>(<span style="color:#a6e22e">account</span>, <span style="color:#a6e22e">managerAddress</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">token1</span>.<span style="color:#a6e22e">allowance</span>(<span style="color:#a6e22e">account</span>, <span style="color:#a6e22e">managerAddress</span>)
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>然后我们会检查现在的许可是否足够完成这笔交易。如果不够，我们需要发送一个<code>approve</code>交易，让用户同意管理合约花费他的一定数量的token。在确保用户approve足够的数量之后，我们调用<code>manager.mint</code>来添加流动性：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>.<span style="color:#a6e22e">then</span>(([<span style="color:#a6e22e">allowance0</span>, <span style="color:#a6e22e">allowance1</span>]) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> Promise.<span style="color:#a6e22e">resolve</span>()
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">then</span>(() =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">allowance0</span>.<span style="color:#a6e22e">lt</span>(<span style="color:#a6e22e">amount0</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">token0</span>.<span style="color:#a6e22e">approve</span>(<span style="color:#a6e22e">managerAddress</span>, <span style="color:#a6e22e">amount0</span>).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">tx</span> =&gt; <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">wait</span>())
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">then</span>(() =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">allowance1</span>.<span style="color:#a6e22e">lt</span>(<span style="color:#a6e22e">amount1</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">token1</span>.<span style="color:#a6e22e">approve</span>(<span style="color:#a6e22e">managerAddress</span>, <span style="color:#a6e22e">amount1</span>).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">tx</span> =&gt; <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">wait</span>())
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">then</span>(() =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">manager</span>.<span style="color:#a6e22e">mint</span>(<span style="color:#a6e22e">poolAddress</span>, <span style="color:#a6e22e">lowerTick</span>, <span style="color:#a6e22e">upperTick</span>, <span style="color:#a6e22e">liquidity</span>, <span style="color:#a6e22e">extra</span>)
</span></span><span style="display:flex;"><span>        .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">tx</span> =&gt; <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">wait</span>())
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">then</span>(() =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">alert</span>(<span style="color:#e6db74">&#39;Liquidity added!&#39;</span>);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><blockquote>
<p><code>lt</code> 是<a href="https://docs.ethers.io/v5/api/utils/bignumber/">BigNumber</a>的一个方法。Ethers.js 使用 BigNumber来代表<code>uint256</code>类型，因为JavaScript本身<a href="https://docs.ethers.io/v5/api/utils/bignumber/#BigNumber--notes-safenumbers">精度不足</a>。这也是我们希望有一个库的原因。</p>
</blockquote>
<p>除了token许可的部分以外，这跟测试合约基本一致。</p>
<p>上述代码中的<code>token0</code>, <code>token1</code>, 和 <code>manager</code> 都是<code>Contract</code>的实例。<code>approve</code> 和 <code>mint</code> 都是合约函数，是从我们初始化合约时提供的ABI中动态生成的。当调用这些方法时，Ethers.js会：</p>
<ol>
<li>编码函数参数；</li>
<li>构建一个交易；</li>
<li>将交易传递给MetaMask并请求签名；用户看到MetaMask弹窗并点击“确认”；</li>
<li>将交易发送给MetaMask连接的节点；</li>
<li>返回包含这笔交易完整信息的一个对象。</li>
</ol>
<p>交易对象包含一个<code>wait</code>函数，我们调用它来等待一个交易上链——这能够让我们等待这一笔交易成功再执行下一笔交易。</p>
<blockquote>
<p>以太坊对于交易顺序有严格要求。还记得nonce嘛？它是账户级别对于交易的index。每一笔新的交易都会增加这个index，并且以太坊只有在上一笔交易（nonce更小的交易）执行完成后才会执行下一笔交易。</p>
</blockquote>
<h3 id="交易token">
  交易Token
  <a class="anchor" href="#%e4%ba%a4%e6%98%93token">#</a>
</h3>
<p>在交易token时，我们使用相同的模式：从用户输入获取参数，检查许可，调用管理合约的<code>swap</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">swap</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">amountIn</span>, <span style="color:#a6e22e">account</span>, { <span style="color:#a6e22e">tokenIn</span>, <span style="color:#a6e22e">manager</span>, <span style="color:#a6e22e">token0</span>, <span style="color:#a6e22e">token1</span> }, { <span style="color:#a6e22e">managerAddress</span>, <span style="color:#a6e22e">poolAddress</span> }) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">amountInWei</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ethers</span>.<span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">parseEther</span>(<span style="color:#a6e22e">amountIn</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">extra</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ethers</span>.<span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">defaultAbiCoder</span>.<span style="color:#a6e22e">encode</span>(
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;address&#34;</span>, <span style="color:#e6db74">&#34;address&#34;</span>, <span style="color:#e6db74">&#34;address&#34;</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#a6e22e">token0</span>.<span style="color:#a6e22e">address</span>, <span style="color:#a6e22e">token1</span>.<span style="color:#a6e22e">address</span>, <span style="color:#a6e22e">account</span>]
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">tokenIn</span>.<span style="color:#a6e22e">allowance</span>(<span style="color:#a6e22e">account</span>, <span style="color:#a6e22e">managerAddress</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">allowance</span>) =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">allowance</span>.<span style="color:#a6e22e">lt</span>(<span style="color:#a6e22e">amountInWei</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">tokenIn</span>.<span style="color:#a6e22e">approve</span>(<span style="color:#a6e22e">managerAddress</span>, <span style="color:#a6e22e">amountInWei</span>).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">tx</span> =&gt; <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">wait</span>())
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">then</span>(() =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">manager</span>.<span style="color:#a6e22e">swap</span>(<span style="color:#a6e22e">poolAddress</span>, <span style="color:#a6e22e">extra</span>).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">tx</span> =&gt; <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">wait</span>())
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">then</span>(() =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">alert</span>(<span style="color:#e6db74">&#39;Swap succeeded!&#39;</span>);
</span></span><span style="display:flex;"><span>    }).<span style="color:#66d9ef">catch</span>((<span style="color:#a6e22e">err</span>) =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">alert</span>(<span style="color:#e6db74">&#39;Failed!&#39;</span>);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>唯一新出现的函数就只有 <code>ethers.utils.parseEther()</code>，用来把ether单位的数值转换成wei单位，以太坊中的最小单位（译者注：也即合约中使用的单位）。</p>
<h3 id="订阅更新">
  订阅更新
  <a class="anchor" href="#%e8%ae%a2%e9%98%85%e6%9b%b4%e6%96%b0">#</a>
</h3>
<p>对于一个去中心化的应用，反应当前的区块链状态时很重要的。例如，在一个去中心化的交易市场中，正确地计算现在的价格是很重要的；过时的数据可能会导致滑点(slippage)并使得交易失败。</p>
<p>当开发池子合约的时候，我们学习过event，它能够作为区块链数据的索引：无论何时智能合约的状态发生改变都发出一个event是种好习惯，因为event
能够作为索引帮助快速搜索需要的信息。我们现在需要做的，就是订阅合约的event来保证前端app的实时更新。让我们来实现这部分吧！</p>
<p>如果你在之前看过了上一章forge生成的ABI，你会发现其中也包含event的描述：名字和参数。很棒的是：[Ethers.js会处理它们]并且为我们提供一个接口来订阅新的event。我们来看一下它是怎么工作的。</p>
<p>订阅事件需要使用<code>on(EVENT_NAME, handler)</code>函数。callback会接受event的所有值和event本身来作为参数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">subscribeToEvents</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">pool</span>, <span style="color:#a6e22e">callback</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#34;Mint&#34;</span>, (<span style="color:#a6e22e">sender</span>, <span style="color:#a6e22e">owner</span>, <span style="color:#a6e22e">tickLower</span>, <span style="color:#a6e22e">tickUpper</span>, <span style="color:#a6e22e">amount</span>, <span style="color:#a6e22e">amount0</span>, <span style="color:#a6e22e">amount1</span>, <span style="color:#a6e22e">event</span>) =&gt; <span style="color:#a6e22e">callback</span>(<span style="color:#a6e22e">event</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#34;Swap&#34;</span>, (<span style="color:#a6e22e">sender</span>, <span style="color:#a6e22e">recipient</span>, <span style="color:#a6e22e">amount0</span>, <span style="color:#a6e22e">amount1</span>, <span style="color:#a6e22e">sqrtPriceX96</span>, <span style="color:#a6e22e">liquidity</span>, <span style="color:#a6e22e">tick</span>, <span style="color:#a6e22e">event</span>) =&gt; <span style="color:#a6e22e">callback</span>(<span style="color:#a6e22e">event</span>));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>如果想要筛选和拿到之前的event，我们可以使用<code>queryFilter</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>Promise.<span style="color:#a6e22e">all</span>([
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">queryFilter</span>(<span style="color:#e6db74">&#34;Mint&#34;</span>, <span style="color:#e6db74">&#34;earliest&#34;</span>, <span style="color:#e6db74">&#34;latest&#34;</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">queryFilter</span>(<span style="color:#e6db74">&#34;Swap&#34;</span>, <span style="color:#e6db74">&#34;earliest&#34;</span>, <span style="color:#e6db74">&#34;latest&#34;</span>),
</span></span><span style="display:flex;"><span>]).<span style="color:#a6e22e">then</span>(([<span style="color:#a6e22e">mints</span>, <span style="color:#a6e22e">swaps</span>]) =&gt; {
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>你可能注意到，event中的一些参数被标注为<code>indexed</code>——这样的域能够被以太坊节点作为索引，允许通过某些域的值来搜索事件。例如，<code>Swap</code>事件有<code>sender</code> 和 <code>recipient</code>两个域被标注为<code>indexed</code>，因此我们可以通过交易的发送者和接收者来搜索对应交易。Ethers.js当然也提供了这个功能：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">swapFilter</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">filters</span>.<span style="color:#a6e22e">Swap</span>(<span style="color:#a6e22e">sender</span>, <span style="color:#a6e22e">recipient</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">swaps</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">queryFilter</span>(<span style="color:#a6e22e">swapFilter</span>, <span style="color:#a6e22e">fromBlock</span>, <span style="color:#a6e22e">toBlock</span>);
</span></span></code></pre></div><hr>
<p>OK！现在我们彻底完成了milestone 1!</p>
<p style="font-size:3rem; text-align: center">
🎉🍾🍾🍾🎉
</p></article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#用户界面">用户界面</a>
      <ul>
        <li><a href="#相关工具一览">相关工具一览</a>
          <ul>
            <li><a href="#什么是metamask">什么是MetaMask？</a></li>
            <li><a href="#常用库">常用库</a></li>
          </ul>
        </li>
        <li><a href="#工作流">工作流</a>
          <ul>
            <li><a href="#连接到本地节点">连接到本地节点</a></li>
            <li><a href="#链接到metamask">链接到MetaMask</a></li>
            <li><a href="#提供流动性">提供流动性</a></li>
            <li><a href="#交易token">交易Token</a></li>
            <li><a href="#订阅更新">订阅更新</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












